<!DOCTYPE html>
<html>
<head>
    <title>Galleries - Zulu Club</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 30px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #795548;
            padding-bottom: 10px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
            align-items: center;
        }
        button {
            padding: 10px 20px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .back-btn {
            background: #6c757d;
            color: white;
        }
        .refresh-btn {
            background: #2196F3;
            color: white;
        }
        .filter-btn {
            background: #4CAF50;
            color: white;
        }
        .filter-btn.inactive {
            background: #f44336;
        }
        .sort-btn {
            background: #5D4037;
            color: white;
        }
        .sort-btn.active {
            background: #4E342E;
            box-shadow: 0 0 0 2px rgba(93, 64, 55, 0.3);
        }
        #message {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #loading {
            padding: 20px;
            text-align: center;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            margin: 20px 0;
            color: #856404;
        }
        #error {
            padding: 20px;
            text-align: center;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            margin: 20px 0;
            color: #721c24;
        }
        #dataContainer {
            overflow-x: auto;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background: #795548;
            color: white;
            padding: 12px 15px;
            text-align: left;
            position: sticky;
            top: 0;
            cursor: pointer;
            transition: background 0.3s;
        }
        th:hover {
            background: #5D4037;
        }
        td {
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        td.editable:hover {
            background: #f0f8ff;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(121, 85, 72, 0.1);
            z-index: 1;
        }
        td.editable::after {
            content: '‚úèÔ∏è';
            position: absolute;
            top: 50%;
            right: 5px;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 10px;
        }
        td.editable:hover::after {
            opacity: 1;
        }
        tr:hover td {
            background: #f9f9f9;
        }
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        .priority-high {
            background: #e8f5e9 !important;
            border-left: 4px solid #2E7D32;
        }
        .priority-medium {
            background: #e3f2fd !important;
            border-left: 4px solid #2196F3;
        }
        .priority-low {
            background: #fff3e0 !important;
            border-left: 4px solid #FF9800;
        }
        .priority-outlier {
            background: #f5f5f5 !important;
            border-left: 4px solid #9E9E9E;
        }
        .status-active {
            background: #e8f5e9 !important;
        }
        .status-inactive {
            background: #ffebee !important;
        }
        .cache-info {
            background: #efebe9;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
            color: #5d4037;
        }
        .filter-controls {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .sort-controls {
            background: #d7ccc8;
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .version-controls {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #4CAF50;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
        .stats-info {
            font-size: 14px;
            color: #333;
        }
        .stats-info span {
            margin-right: 15px;
        }
        .stats-info .active {
            color: #4CAF50;
        }
        .stats-info .inactive {
            color: #f44336;
        }
        .priority-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .version-filter-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .status-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .status-btn {
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
        .status-btn.active {
            background: #4CAF50;
            color: white;
        }
        .status-btn.inactive {
            background: #f44336;
            color: white;
        }
        .status-btn.all {
            background: #795548;
            color: white;
        }
        .search-box {
            flex-grow: 1;
            max-width: 300px;
        }
        .search-box input {
            width: 100%;
            padding: 8px 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
            transition: all 0.3s;
        }
        .search-box input:focus {
            outline: none;
            border-color: #795548;
            box-shadow: 0 0 0 3px rgba(121, 85, 72, 0.1);
        }
        .pagination-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            border: 1px solid #dee2e6;
        }
        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            color: #333;
        }
        .page-size-selector select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 2px solid #ddd;
            background: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .page-size-selector select:focus {
            outline: none;
            border-color: #795548;
        }
        .page-info {
            font-weight: bold;
            color: #333;
            text-align: center;
        }
        .pagination-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .pagination-buttons button {
            padding: 8px 15px;
            font-size: 14px;
            background: #795548;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .pagination-buttons button:hover:not(:disabled) {
            background: #5D4037;
            transform: translateY(-2px);
        }
        .pagination-buttons button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        .page-number {
            padding: 8px 12px;
            background: #795548;
            color: white;
            border-radius: 5px;
            font-weight: bold;
            margin: 0 2px;
            cursor: default;
        }
        .page-number:hover {
            background: #5D4037;
        }
        mark {
            background-color: yellow;
            padding: 0 2px;
            border-radius: 2px;
        }
        /* Image Preview Styles */
        .image-cell {
            position: relative;
            padding: 0 !important;
            height: 200px;
            min-width: 200px;
        }
        .image-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }
        .external-link-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }
        .image-actions {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s;
            border-radius: 4px;
        }
        .image-cell:hover .image-actions {
            opacity: 1;
        }
        .image-action-btn {
            padding: 4px 8px;
            font-size: 11px;
            background: white;
            color: #333;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .image-action-btn:hover {
            background: #2196F3;
            color: white;
            transform: scale(1.1);
        }
        .image-action-btn.delete {
            background: #f44336;
            color: white;
        }
        .image-action-btn.delete:hover {
            background: #d32f2f;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        .modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.5rem;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        .close-modal:hover {
            background: #f5f5f5;
            color: #333;
        }
        .field-info {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #795548;
        }
        .field-info h3 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 16px;
        }
        .field-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
            transition: all 0.3s;
        }
        .form-control:focus {
            outline: none;
            border-color: #795548;
            box-shadow: 0 0 0 3px rgba(121, 85, 72, 0.1);
        }
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }
        .save-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
        .save-btn:hover {
            background: #218838;
        }
        .cancel-btn {
            background: #6c757d;
            color: white;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
        .cancel-btn:hover {
            background: #5a6268;
        }
        .current-image-container {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #ddd;
        }
        .current-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .upload-container {
            border: 2px dashed #2196F3;
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            background: #f8f9fa;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .upload-container.dragover {
            border-color: #4CAF50;
            background: #e8f5e9;
        }
        .upload-btn {
            background: #2196F3;
            color: white;
            padding: 12px 25px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .upload-btn:hover {
            background: #0b7dda;
        }
        .upload-info {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .file-input {
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
            display: none;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.3s;
        }
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            display: none;
        }
        .image-preview-item {
            width: 100px;
            height: 100px;
            position: relative;
            border-radius: 5px;
            overflow: hidden;
            border: 2px solid #ddd;
        }
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .remove-preview {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
        }
        .supported-formats {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }
        .uploaded-url {
            margin-top: 15px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 5px;
            word-break: break-all;
            font-size: 12px;
            display: none;
        }
        .uploaded-url a {
            color: #2196F3;
            text-decoration: none;
        }
        .uploaded-url a:hover {
            text-decoration: underline;
        }
        .external-link-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #2196F3;
        }
        .external-link-info h4 {
            margin: 0 0 5px 0;
            color: #1565C0;
        }
        .external-link-info p {
            margin: 0;
            color: #333;
            font-size: 13px;
        }
        @media (max-width: 768px) {
            body {
                margin: 15px;
            }
            .controls {
                flex-direction: column;
            }
            .controls button {
                width: 100%;
            }
            .search-box {
                max-width: 100%;
            }
            .pagination-controls {
                flex-direction: column;
                gap: 15px;
            }
            table {
                font-size: 12px;
            }
            th, td {
                padding: 8px 10px;
            }
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            .modal-actions {
                flex-direction: column;
            }
            .image-cell {
                height: 60px;
            }
            .image-action-btn {
                padding: 3px 6px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <h1>üñºÔ∏è Galleries Data</h1>
    
    <div class="controls">
        <button class="back-btn" onclick="location.href='/'">‚Üê Back to Dashboard</button>
        <button class="refresh-btn" onclick="loadData()">üîÑ Refresh Data</button>
        <button class="filter-btn" id="toggleStatusFilterBtn" onclick="toggleStatusFilter()">Active Galleries Only</button>
        <button class="sort-btn" id="toggleSortBtn" onclick="toggleSort()">Sort by Priority</button>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="üîç Search galleries..." onkeyup="handleSearch()">
        </div>
    </div>
    
    <div class="filter-controls">
        <div class="status-controls">
            <div style="display: flex; align-items: center; gap: 10px;">
                <label class="toggle-switch">
                    <input type="checkbox" id="statusFilter" checked onchange="toggleStatusFilter()">
                    <span class="toggle-slider"></span>
                </label>
                <span style="font-weight: bold;">Status Filter:</span>
            </div>
            <button class="status-btn active" onclick="setStatusFilter('active')">Active Only</button>
            <button class="status-btn inactive" onclick="setStatusFilter('inactive')">Inactive Only</button>
            <button class="status-btn all" onclick="setStatusFilter('all')">Show All</button>
        </div>
        <div class="stats-info">
            <span class="active">Active: <span id="activeCount">0</span></span>
            <span class="inactive">Inactive: <span id="inactiveCount">0</span></span>
            <span>Total: <span id="totalCount">0</span></span>
            <span>Showing: <span id="showingCount">0</span></span>
        </div>
    </div>
    
    <div class="sort-controls">
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-weight: bold;">Sort Order:</span>
            <select id="priorityOrder" onchange="applySorting()" style="padding: 8px; border-radius: 5px; border: 2px solid #ddd;">
                <option value="asc">Highest First (1‚Üí10)</option>
                <option value="desc">Lowest First (10‚Üí1)</option>
                <option value="outliers">Outliers First</option>
            </select>
        </div>
        <div class="priority-controls">
            <span style="font-weight: bold;">Priority Filter:</span>
            <label>
                <input type="checkbox" id="showOutliers" checked onchange="toggleOutliers()"> Show Outliers
            </label>
            <select id="priorityFilter" onchange="applyPriorityFilter()" style="padding: 8px; border-radius: 5px; border: 2px solid #ddd;">
                <option value="all">All Priorities (1-10)</option>
                <option value="1">Priority 1 (Highest)</option>
                <option value="2">Priority 2</option>
                <option value="3">Priority 3</option>
                <option value="4">Priority 4</option>
                <option value="5">Priority 5</option>
                <option value="6">Priority 6</option>
                <option value="7">Priority 7</option>
                <option value="8">Priority 8</option>
                <option value="9">Priority 9</option>
                <option value="10">Priority 10 (Lowest)</option>
            </select>
        </div>
        <div class="stats-info">
            <span>P1-3: <span id="priorityHighCount">0</span></span>
            <span>P4-6: <span id="priorityMediumCount">0</span></span>
            <span>P7-9: <span id="priorityLowCount">0</span></span>
            <span>P10: <span id="priorityLowestCount">0</span></span>
            <span>Outliers: <span id="outlierCount">0</span></span>
        </div>
    </div>
    
    <!-- NEW VERSION FILTER SECTION -->
    <div class="version-controls">
        <div class="version-filter-controls">
            <span style="font-weight: bold;">Version Filter:</span>
            <select id="versionFilter" onchange="applyVersionFilter()" style="padding: 8px; border-radius: 5px; border: 2px solid #ddd;">
                <option value="all">All Versions</option>
                <option value="1">Version 1</option>
                <option value="2">Version 2</option>
                <option value="3">Version 3</option>
                <option value="4">Version 4</option>
                <option value="5">Version 5</option>
                <option value="6">Version 6</option>
                <option value="7">Version 7</option>
                <option value="8">Version 8</option>
                <option value="9">Version 9</option>
                <option value="10">Version 10</option>
            </select>
        </div>
        <div class="stats-info">
            <span>V1: <span id="version1Count">0</span></span>
            <span>V2: <span id="version2Count">0</span></span>
            <span>V3: <span id="version3Count">0</span></span>
            <span>V4: <span id="version4Count">0</span></span>
            <span>V5: <span id="version5Count">0</span></span>
            <span>V6: <span id="version6Count">0</span></span>
            <span>V7: <span id="version7Count">0</span></span>
            <span>V8: <span id="version8Count">0</span></span>
            <span>V9: <span id="version9Count">0</span></span>
            <span>V10: <span id="version10Count">0</span></span>
        </div>
    </div>
    
    <div class="pagination-controls">
        <div class="page-size-selector">
            <span style="font-weight: bold;">Show:</span>
            <select id="pageSize" onchange="changePageSize()">
                <option value="10">10 per page</option>
                <option value="50" selected>50 per page</option>
                <option value="100">100 per page</option>
                <option value="500">500 per page</option>
                <option value="0">Show All</option>
            </select>
        </div>
        
        <div class="page-info">
            Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
            (<span id="showingInfo">0</span> galleries)
        </div>
        
        <div class="pagination-buttons">
            <button id="firstPageBtn" onclick="goToPage(1)">¬´ First</button>
            <button id="prevPageBtn" onclick="prevPage()">‚Äπ Previous</button>
            <span id="pageNumbers"></span>
            <button id="nextPageBtn" onclick="nextPage()">Next ‚Ä∫</button>
            <button id="lastPageBtn" onclick="goToLastPage()">Last ¬ª</button>
        </div>
    </div>
    
    <div id="message"></div>
    <div id="loading">Loading galleries data...</div>
    <div id="error" style="display: none;"></div>
    
    <div id="dataContainer"></div>

    <!-- Edit Modal for Regular Fields -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Field</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            
            <div class="field-info">
                <h3 id="fieldName"></h3>
                <p id="fieldInfo">Editing single field value</p>
            </div>
            
            <form id="editForm">
                <div class="form-group">
                    <label id="fieldLabel"></label>
                    <div id="fieldInput"></div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="save-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Image Upload Modal for Server Images -->
    <div id="imageUploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="imageModalTitle"></h2>
                <button class="close-modal" onclick="closeImageModal()">&times;</button>
            </div>
            
            <div class="field-info">
                <h3 id="imageFieldName"></h3>
                <p id="imageFieldInfo"></p>
            </div>
            
            <!-- Current Image Preview -->
            <div id="currentImageContainer" class="current-image-container">
                <h4>Current Image</h4>
                <img id="currentImagePreview" class="current-image" src="" alt="Current Image">
                <div id="currentImageActions" style="margin-top: 10px;">
                    <button onclick="viewCurrentImage()" class="image-action-btn">View</button>
                    <button onclick="deleteCurrentImage()" class="image-action-btn delete">Delete</button>
                </div>
            </div>
            
            <!-- Upload Section -->
            <div class="upload-container" id="uploadContainer">
                <input type="file" id="imageFileInput" class="file-input" accept="image/*">
                <button type="button" class="upload-btn" onclick="document.getElementById('imageFileInput').click()">
                    üìÅ Choose Image to Upload
                </button>
                <p class="upload-info">or drag and drop image here</p>
                <div class="supported-formats">
                    Supported formats: JPG, PNG, GIF, WEBP (Max 5MB)
                </div>
            </div>
            
            <!-- Upload Progress -->
            <div class="progress-bar" id="uploadProgress">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <!-- Uploaded Image Preview -->
            <div class="image-preview-container" id="imagePreviewContainer">
                <div class="image-preview-item">
                    <img id="uploadedImagePreview" src="" alt="Uploaded Image">
                    <button class="remove-preview" onclick="removeUploadedImage()">√ó</button>
                </div>
            </div>
            
            <!-- Uploaded URL -->
            <div class="uploaded-url" id="uploadedUrl">
                <strong>Uploaded URL:</strong><br>
                <span id="uploadedUrlText"></span>
                <br>
                <a id="uploadedUrlLink" href="#" target="_blank">Open Image ‚Üó</a>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="cancel-btn" onclick="closeImageModal()">Cancel</button>
                <button type="button" class="save-btn" id="saveImageBtn" onclick="saveImage()" disabled>Save Image</button>
            </div>
        </div>
    </div>

    <!-- External Link Edit Modal -->
    <div id="externalLinkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="externalLinkModalTitle"></h2>
                <button class="close-modal" onclick="closeExternalLinkModal()">&times;</button>
            </div>
            
            <div class="field-info">
                <h3 id="externalLinkFieldName"></h3>
                <p id="externalLinkFieldInfo"></p>
            </div>
            
            <div class="external-link-info">
                <h4>‚ö†Ô∏è External Link Detected</h4>
                <p>This is an external link (e.g., Google Drive, Dropbox, etc.). You can edit the URL or delete it, but you cannot upload a new image directly here.</p>
            </div>
            
            <!-- Current Image/Link Preview -->
            <div id="externalLinkContainer" class="current-image-container">
                <h4>Current Link</h4>
                <div style="word-break: break-all; padding: 10px; background: white; border-radius: 5px; margin-bottom: 10px;">
                    <span id="currentExternalLink"></span>
                </div>
                <div id="externalLinkActions" style="margin-top: 10px;">
                    <button onclick="viewExternalLink()" class="image-action-btn">View Link</button>
                    <button onclick="deleteExternalLink()" class="image-action-btn delete">Delete Link</button>
                </div>
            </div>
            
            <!-- Edit URL Form -->
            <form id="externalLinkForm">
                <div class="form-group">
                    <label for="externalLinkUrl">Edit URL:</label>
                    <input type="url" id="externalLinkUrl" class="form-control" placeholder="https://example.com/image.jpg">
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        Enter the full URL of the external image (Google Drive, Dropbox, etc.)
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="closeExternalLinkModal()">Cancel</button>
                    <button type="submit" class="save-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let allData = [];          // All data from API
        let filteredData = [];     // Data after filters
        let currentData = [];      // Data for current page
        let statusFilter = 'active'; // 'active', 'inactive', 'all'
        let sortByPriority = true;
        let priorityOrder = 'asc'; // Changed to asc for highest first (1‚Üí10)
        let showOutliers = true;
        let priorityFilter = 'all';
        let versionFilter = 'all'; // NEW: Version filter
        let searchTerm = '';
        let searchTimeout = null;
        
        // Edit functionality variables
        let currentEditId = null;
        let currentEditField = null;
        let originalValue = null;
        
        // Image upload variables
        let currentImageId = null;
        let currentImageField = null;
        let currentImageUrl = null;
        let uploadedImageUrl = null;
        let uploadedFile = null;
        
        // External link variables
        let currentExternalLinkId = null;
        let currentExternalLinkField = null;
        let currentExternalLinkUrl = null;
        
        // Pagination variables
        let currentPage = 1;
        let pageSize = 50; // Default 50 per page
        let totalPages = 1;
        let totalFilteredItems = 0;

        // Helper function to get full image URL
        function getFullImageUrl(url) {
            if (!url || url.trim() === '') {
                return '';
            }
            
            // If it's already a full URL, return as is
            if (url.startsWith('http://') || url.startsWith('https://')) {
                return url;
            }
            
            // If it's a relative path starting with uploads/, prepend base URL
            if (url.startsWith('uploads/')) {
                return 'https://zulushop.in/' + url;
            }
            
            // Default: prepend base URL
            return 'https://zulushop.in/' + url;
        }

        // Helper function to check if field is an image field
        function isImageField(fieldName) {
            const imgFields = ['image1', 'image2', 'image3', 'image4', 
                              'image_1', 'image_2', 'image_3', 'image_4',
                              'imageone', 'imagetwo', 'imagethree', 'imagefour',
                              'image_one', 'image_two', 'image_three', 'image_four',
                              'main_image', 'thumbnail', 'cover', 'banner'];
            
            return imgFields.includes(fieldName.toLowerCase());
        }

        // Helper function to check if URL is external (not from zulushop.in)
        function isExternalLink(url) {
            if (!url || url.trim() === '') {
                return false;
            }
            
            // Get full URL for comparison
            const fullUrl = getFullImageUrl(url);
            
            // Check if it's from zulushop.in
            if (fullUrl.includes('zulushop.in')) {
                return false;
            }
            
            // Check for common external services
            const externalDomains = [
                'drive.google.com',
                'dropbox.com',
                'onedrive.live.com',
                'imgur.com',
                'flickr.com',
                'imageshack.com',
                'postimg.org',
                'tinypic.com',
                'photobucket.com',
                'api.'
            ];
            
            for (const domain of externalDomains) {
                if (fullUrl.includes(domain)) {
                    return true;
                }
            }
            
            // If it's a full URL but not from zulushop.in, consider it external
            return fullUrl.startsWith('http://') || fullUrl.startsWith('https://');
        }

        // Helper function to get image preview URL for external links
        function getImagePreviewUrl(url) {
            if (!url || url.trim() === '') {
                return '';
            }
            
            const fullUrl = getFullImageUrl(url);
            
            // For Google Drive links, try to get a preview
            if (fullUrl.includes('drive.google.com')) {
                if (fullUrl.includes('/file/d/')) {
                    // Convert Google Drive file link to preview link
                    const match = fullUrl.match(/\/file\/d\/([^\/]+)/);
                    if (match) {
                        return `https://drive.google.com/uc?export=view&id=${match[1]}`;
                    }
                }
            }
            
            // For other external links, try to use the URL directly
            return fullUrl;
        }

        async function loadData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('dataContainer').innerHTML = '';
            
            try {
                const response = await fetch('/api/galleries');
                const data = await response.json();
                
                console.log('API Response:', data);
                
                if (data && data.success) {
                    if (Array.isArray(data.data)) {
                        allData = data.data;
                        
                        // Process data for consistent format
                        if (allData.length > 0) {
                            allData = allData.map((gallery, index) => {
                                // Ensure id exists
                                if (!gallery.id) gallery.id = index + 1;
                                
                                // Process status field - keep as string but add isActive flag
                                if (gallery.status !== undefined) {
                                    let status = gallery.status;
                                    if (typeof status === 'string') {
                                        const statusStr = status.toLowerCase().trim();
                                        // Add isActive flag for filtering
                                        gallery.isActive = (
                                            statusStr === 'on' || 
                                            statusStr === 'active' || 
                                            statusStr === 'true' || 
                                            statusStr === '1' || 
                                            statusStr === 'yes' ||
                                            statusStr === 'enabled'
                                        );
                                        // Keep original status string
                                        gallery.status = status;
                                    } else {
                                        // If it's not a string, convert to string
                                        gallery.status = String(status);
                                        gallery.isActive = (status === 1 || status === true);
                                    }
                                } else {
                                    // If no status, default to inactive
                                    gallery.status = 'inactive';
                                    gallery.isActive = false;
                                }
                                
                                // Get priority value and classify (1-10 normal, others outliers)
                                let priority = Number(gallery.priority) || 1;
                                let isOutlier = priority < 1 || priority > 10;
                                
                                // Normalize priority for display (1-10)
                                if (priority < 1) priority = 1;
                                if (priority > 10) priority = 10;
                                
                                // Get version value
                                let version = Number(gallery.version) || 1;
                                if (version < 1) version = 1;
                                if (version > 10) version = 10;
                                
                                return {
                                    ...gallery,
                                    priority: priority,
                                    version: version,
                                    isOutlier: isOutlier,
                                    original_priority: gallery.priority, // Keep original for display
                                    id: gallery.id || index + 1
                                };
                            });
                        }
                        
                        applyFilter();
                        showMessage(`Loaded ${allData.length} galleries`, 'success');
                        updateStats();
                        updatePriorityStats();
                        updateVersionStats(); // NEW: Update version stats
                        updateStatusButtons();
                        
                        // Show cache info
                        const cacheDiv = document.createElement('div');
                        cacheDiv.className = 'cache-info';
                        cacheDiv.innerHTML = `
                            <strong>Cache Info:</strong> Data is cached for 2 hours. 
                            To force fresh data, clear cache from Dashboard.
                            Database connection closes after 5 minutes of inactivity.
                        `;
                        document.getElementById('dataContainer').prepend(cacheDiv);
                    } else {
                        console.error('Invalid data format:', data.data);
                        showError('Invalid data format received from server');
                    }
                } else {
                    console.error('API returned error:', data);
                    showError(`API Error: ${data ? data.error || 'Unknown error' : 'No response'}`);
                }
            } catch (error) {
                console.error('Fetch error:', error);
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Error: ' + error.message;
                showMessage(`Network error: ${error.message}`, 'error');
                document.getElementById('dataContainer').innerHTML = 
                    '<div style="padding: 40px; text-align: center; color: #666;">Network error. Please check your connection.</div>';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function applyFilter() {
            filteredData = [...allData];
            
            // Apply status filter - check isActive flag
            if (statusFilter === 'active') {
                filteredData = filteredData.filter(gallery => {
                    return gallery.isActive === true;
                });
            } else if (statusFilter === 'inactive') {
                filteredData = filteredData.filter(gallery => {
                    return gallery.isActive === false;
                });
            }
            
            // Apply outlier filter
            if (!showOutliers) {
                filteredData = filteredData.filter(gallery => !gallery.isOutlier);
            }
            
            // Apply priority filter
            if (priorityFilter !== 'all') {
                const selectedPriority = parseInt(priorityFilter);
                filteredData = filteredData.filter(gallery => {
                    if (gallery.isOutlier) return false;
                    return Number(gallery.priority) === selectedPriority;
                });
            }
            
            // NEW: Apply version filter
            if (versionFilter !== 'all') {
                const selectedVersion = parseInt(versionFilter);
                filteredData = filteredData.filter(gallery => {
                    return Number(gallery.version) === selectedVersion;
                });
            }
            
            // Apply search filter
            if (searchTerm.trim() !== '') {
                const searchLower = searchTerm.toLowerCase();
                filteredData = filteredData.filter(gallery => {
                    return Object.values(gallery).some(value => {
                        if (typeof value === 'string') {
                            return value.toLowerCase().includes(searchLower);
                        } else if (typeof value === 'number') {
                            return value.toString().includes(searchTerm);
                        }
                        return false;
                    });
                });
            }
            
            totalFilteredItems = filteredData.length;
            
            // Apply sorting
            applySorting();
            
            updateFilterButton();
            updateSortButton();
            updateSearchResults();
            updatePagination();
            displayCurrentPage();
        }
        
        function applySorting() {
            if (filteredData.length === 0) {
                return;
            }
            
            priorityOrder = document.getElementById('priorityOrder').value;
            
            let sortedData = [...filteredData];
            
            if (sortByPriority) {
                if (priorityOrder === 'outliers') {
                    // Outliers first, then by priority (1 highest, 10 lowest)
                    sortedData.sort((a, b) => {
                        // Outliers first
                        if (a.isOutlier && !b.isOutlier) return -1;
                        if (!a.isOutlier && b.isOutlier) return 1;
                        
                        // Both outliers or both normal
                        const priorityA = Number(a.priority) || 0;
                        const priorityB = Number(b.priority) || 0;
                        return priorityA - priorityB; // Ascending (1‚Üí10) for normal
                    });
                } else if (priorityOrder === 'asc') {
                    // Ascending: 1‚Üí10 (highest first), outliers at end
                    sortedData.sort((a, b) => {
                        // Normal priorities first
                        if (!a.isOutlier && b.isOutlier) return -1;
                        if (a.isOutlier && !b.isOutlier) return 1;
                        
                        // Both same type
                        const priorityA = Number(a.priority) || 0;
                        const priorityB = Number(b.priority) || 0;
                        return priorityA - priorityB; // Ascending (1‚Üí10)
                    });
                } else {
                    // Descending: 10‚Üí1 (lowest first), outliers at end
                    sortedData.sort((a, b) => {
                        // Normal priorities first
                        if (!a.isOutlier && b.isOutlier) return -1;
                        if (a.isOutlier && !b.isOutlier) return 1;
                        
                        // Both same type
                        const priorityA = Number(a.priority) || 0;
                        const priorityB = Number(b.priority) || 0;
                        return priorityB - priorityA; // Descending (10‚Üí1)
                    });
                }
            } else {
                // No priority sorting, just keep filtered order
            }
            
            filteredData = sortedData;
        }
        
        function handleSearch() {
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            searchTimeout = setTimeout(() => {
                searchTerm = document.getElementById('searchInput').value;
                applyFilter();
            }, 500); // 500ms delay for smoother experience
        }
        
        function setStatusFilter(type) {
            statusFilter = type;
            document.getElementById('statusFilter').checked = (type === 'active');
            applyFilter();
            updateStats();
            updateStatusButtons();
            updateFilterMessage();
        }
        
        function toggleStatusFilter() {
            statusFilter = document.getElementById('statusFilter').checked ? 'active' : 'all';
            applyFilter();
            updateStats();
            updateStatusButtons();
            updateFilterMessage();
        }
        
        function toggleSort() {
            sortByPriority = !sortByPriority;
            applyFilter();
            updateSortMessage();
        }
        
        function toggleOutliers() {
            showOutliers = document.getElementById('showOutliers').checked;
            applyFilter();
            updateFilterMessage();
        }
        
        function applyPriorityFilter() {
            priorityFilter = document.getElementById('priorityFilter').value;
            applyFilter();
            updateFilterMessage();
        }
        
        // NEW: Version filter function
        function applyVersionFilter() {
            versionFilter = document.getElementById('versionFilter').value;
            applyFilter();
            updateFilterMessage();
        }
        
        // Pagination functions
        function updatePagination() {
            pageSize = parseInt(document.getElementById('pageSize').value) || 50;
            
            if (pageSize === 0) {
                totalPages = 1;
                currentPage = 1;
            } else {
                totalPages = Math.ceil(totalFilteredItems / pageSize);
                if (currentPage > totalPages) {
                    currentPage = totalPages || 1;
                }
            }
            
            updatePaginationControls();
            updatePageInfo();
        }
        
        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSize').value) || 50;
            currentPage = 1; // Reset to first page
            applyFilter();
        }
        
        function updatePaginationControls() {
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            
            // Update button states
            document.getElementById('firstPageBtn').disabled = currentPage === 1;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalPages === 0;
            document.getElementById('lastPageBtn').disabled = currentPage === totalPages || totalPages === 0;
            
            // Update page numbers display
            updatePageNumbers();
        }
        
        function updatePageNumbers() {
            const pageNumbersDiv = document.getElementById('pageNumbers');
            let pageNumbersHTML = '';
            
            // Show at most 5 page numbers
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            // Adjust start if we're near the end
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    pageNumbersHTML += `<span class="page-number">${i}</span>`;
                } else {
                    pageNumbersHTML += `<button onclick="goToPage(${i})" style="padding: 8px 12px; border-radius: 5px; background: #6c757d; color: white; border: none; margin: 0 2px;">${i}</button>`;
                }
            }
            
            pageNumbersDiv.innerHTML = pageNumbersHTML;
        }
        
        function goToPage(page) {
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayCurrentPage();
                updatePaginationControls();
            }
        }
        
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                displayCurrentPage();
                updatePaginationControls();
            }
        }
        
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                displayCurrentPage();
                updatePaginationControls();
            }
        }
        
        function goToLastPage() {
            currentPage = totalPages;
            displayCurrentPage();
            updatePaginationControls();
        }
        
        function displayCurrentPage() {
            const container = document.getElementById('dataContainer');
            
            if (filteredData.length === 0) {
                container.innerHTML = 
                    '<div style="padding: 40px; text-align: center; color: #666;">No galleries found matching your criteria</div>';
                return;
            }
            
            let startIndex, endIndex;
            
            if (pageSize === 0) {
                // Show all
                startIndex = 0;
                endIndex = filteredData.length;
                currentData = filteredData;
            } else {
                startIndex = (currentPage - 1) * pageSize;
                endIndex = Math.min(startIndex + pageSize, filteredData.length);
                currentData = filteredData.slice(startIndex, endIndex);
            }
            
            displayData(currentData);
            updatePageInfo();
        }
        
        function updatePageInfo() {
            let showingText;
            if (pageSize === 0) {
                showingText = `${totalFilteredItems}`;
            } else {
                const startIndex = (currentPage - 1) * pageSize + 1;
                const endIndex = Math.min(currentPage * pageSize, totalFilteredItems);
                showingText = `${startIndex}-${endIndex} of ${totalFilteredItems}`;
            }
            
            document.getElementById('showingInfo').textContent = showingText;
            document.getElementById('showingCount').textContent = totalFilteredItems;
        }
        
        function updateFilterButton() {
            const button = document.getElementById('toggleStatusFilterBtn');
            if (statusFilter === 'active') {
                button.textContent = 'Active Galleries Only';
                button.className = 'filter-btn';
            } else {
                button.textContent = 'Show All Galleries';
                button.className = 'filter-btn inactive';
            }
        }
        
        function updateStatusButtons() {
            const activeBtn = document.querySelector('.status-btn.active');
            const inactiveBtn = document.querySelector('.status-btn.inactive');
            const allBtn = document.querySelector('.status-btn.all');
            
            if (!activeBtn) return;
            
            activeBtn.classList.remove('active');
            inactiveBtn.classList.remove('active');
            allBtn.classList.remove('active');
            
            if (statusFilter === 'active') {
                activeBtn.classList.add('active');
            } else if (statusFilter === 'inactive') {
                inactiveBtn.classList.add('active');
            } else {
                allBtn.classList.add('active');
            }
        }
        
        function updateSortButton() {
            const button = document.getElementById('toggleSortBtn');
            if (sortByPriority) {
                button.textContent = 'Sorting by Priority';
                button.className = 'sort-btn active';
                document.getElementById('priorityOrder').disabled = false;
            } else {
                button.textContent = 'Sort by Priority';
                button.className = 'sort-btn';
                document.getElementById('priorityOrder').disabled = true;
            }
        }
        
        function updateStats() {
            if (!allData || !Array.isArray(allData)) {
                document.getElementById('activeCount').textContent = '0';
                document.getElementById('inactiveCount').textContent = '0';
                document.getElementById('totalCount').textContent = '0';
                return;
            }
            
            const activeCount = allData.filter(gallery => {
                return gallery.isActive === true;
            }).length;
            
            const inactiveCount = allData.filter(gallery => {
                return gallery.isActive === false;
            }).length;
            
            document.getElementById('activeCount').textContent = activeCount;
            document.getElementById('inactiveCount').textContent = inactiveCount;
            document.getElementById('totalCount').textContent = allData.length;
        }
        
        function updatePriorityStats() {
            if (!allData || !Array.isArray(allData)) {
                document.getElementById('priorityHighCount').textContent = '0';
                document.getElementById('priorityMediumCount').textContent = '0';
                document.getElementById('priorityLowCount').textContent = '0';
                document.getElementById('priorityLowestCount').textContent = '0';
                document.getElementById('outlierCount').textContent = '0';
                return;
            }
            
            const highCount = allData.filter(gallery => {
                const priority = Number(gallery.priority) || 0;
                return !gallery.isOutlier && priority >= 1 && priority <= 3;
            }).length;
            
            const mediumCount = allData.filter(gallery => {
                const priority = Number(gallery.priority) || 0;
                return !gallery.isOutlier && priority >= 4 && priority <= 6;
            }).length;
            
            const lowCount = allData.filter(gallery => {
                const priority = Number(gallery.priority) || 0;
                return !gallery.isOutlier && priority >= 7 && priority <= 9;
            }).length;
            
            const lowestCount = allData.filter(gallery => {
                const priority = Number(gallery.priority) || 0;
                return !gallery.isOutlier && priority === 10;
            }).length;
            
            const outlierCount = allData.filter(gallery => gallery.isOutlier).length;
            
            document.getElementById('priorityHighCount').textContent = highCount;
            document.getElementById('priorityMediumCount').textContent = mediumCount;
            document.getElementById('priorityLowCount').textContent = lowCount;
            document.getElementById('priorityLowestCount').textContent = lowestCount;
            document.getElementById('outlierCount').textContent = outlierCount;
        }
        
        // NEW: Update version statistics
        function updateVersionStats() {
            if (!allData || !Array.isArray(allData)) {
                for (let i = 1; i <= 10; i++) {
                    document.getElementById(`version${i}Count`).textContent = '0';
                }
                return;
            }
            
            // Count galleries per version (1-10)
            const versionCounts = {};
            for (let i = 1; i <= 10; i++) {
                versionCounts[i] = 0;
            }
            
            allData.forEach(gallery => {
                const version = Number(gallery.version) || 1;
                if (version >= 1 && version <= 10) {
                    versionCounts[version]++;
                }
            });
            
            // Update display
            for (let i = 1; i <= 10; i++) {
                document.getElementById(`version${i}Count`).textContent = versionCounts[i];
            }
        }
        
        function updateSearchResults() {
            if (searchTerm.trim() !== '' && totalFilteredItems > 0) {
                showMessage(`Found ${totalFilteredItems} galleries matching "${searchTerm}"`, 'info');
            }
        }
        
        function updateFilterMessage() {
            let message = `Showing ${totalFilteredItems} galleries`;
            
            if (statusFilter === 'active') {
                message += ` (active only)`;
            } else if (statusFilter === 'inactive') {
                message += ` (inactive only)`;
            }
            
            if (!showOutliers) {
                message += `, outliers hidden`;
            }
            
            if (priorityFilter !== 'all') {
                message += `, priority ${priorityFilter}`;
            }
            
            // NEW: Add version filter info
            if (versionFilter !== 'all') {
                message += `, version ${versionFilter}`;
            }
            
            showMessage(message, 'info');
        }
        
        function updateSortMessage() {
            if (sortByPriority) {
                const order = priorityOrder === 'asc' ? 'highest priority first (1‚Üí10)' : 
                             priorityOrder === 'desc' ? 'lowest priority first (10‚Üí1)' : 
                             'outliers first';
                showMessage(`Sorting by priority (${order})`, 'info');
            } else {
                showMessage(`No priority sorting applied`, 'info');
            }
        }
        
        function displayData(data) {
            const container = document.getElementById('dataContainer');
            
            if (!data || !Array.isArray(data) || data.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #666;">No galleries found matching your criteria</div>';
                return;
            }
            
            const firstRow = data[0];
            if (!firstRow || typeof firstRow !== 'object') {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #666;">Invalid data format</div>';
                return;
            }
            
            // Get headers, excluding internal fields
            const headers = Object.keys(firstRow).filter(header => 
                header !== 'isOutlier' && header !== 'original_priority' && header !== 'isActive'
            );
            
            let html = '<table>';
            
            // Create header row
            html += '<tr>';
            headers.forEach(header => {
                const displayHeader = header.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                const isSortable = header === 'priority' || header === 'id' || header === 'status' || 
                                  header === 'name' || header === 'title' || header === 'description' ||
                                  header === 'version'; // NEW: Make version sortable
                const sortClass = isSortable ? 'sortable' : '';
                html += `<th class="${sortClass}" onclick="sortByColumn('${header}')" title="${isSortable ? 'Click to sort' : ''}">${displayHeader}</th>`;
            });
            html += '</tr>';
            
            // Create data rows
            data.forEach((row, index) => {
                const isActive = row.isActive;
                const status = row.status;
                const priority = Number(row.priority) || 0;
                const version = Number(row.version) || 1; // NEW: Get version
                const isOutlier = row.isOutlier;
                const originalPriority = row.original_priority;
                
                // Determine priority class (same as products: 1-3 high, 4-6 medium, 7-9 low, 10 lowest)
                let priorityClass = 'priority-outlier';
                if (!isOutlier) {
                    if (priority >= 1 && priority <= 3) {
                        priorityClass = 'priority-high';
                    } else if (priority >= 4 && priority <= 6) {
                        priorityClass = 'priority-medium';
                    } else if (priority >= 7 && priority <= 9) {
                        priorityClass = 'priority-low';
                    } else if (priority === 10) {
                        priorityClass = 'priority-outlier'; // Lowest priority
                    }
                }
                
                // Add status class
                if (isActive) {
                    priorityClass += ' status-active';
                } else {
                    priorityClass += ' status-inactive';
                }
                
                html += `<tr class="${priorityClass}">`;
                headers.forEach(header => {
                    let value = row[header];
                    if (value === null || value === undefined) value = '';
                    if (typeof value === 'object') {
                        try {
                            value = JSON.stringify(value);
                        } catch (e) {
                            value = String(value);
                        }
                    }
                    
                    // Add special styling for specific columns
                    let cellStyle = '';
                    let displayValue = String(value);
                    
                    // Check if this is an image field
                    const isImage = isImageField(header);
                    
                    if (isImage) {
                        // For image fields, show thumbnail with action buttons
                        const fullImageUrl = getFullImageUrl(value);
                        const isExternal = isExternalLink(value);
                        const previewUrl = getImagePreviewUrl(value);
                        
                        if (fullImageUrl) {
                            // Show image preview with appropriate actions
                            if (isExternal) {
                                // External link - show preview and external link icon
                                html += `<td class="image-cell" 
                                         data-id="${row.id}" 
                                         data-field="${header}" 
                                         data-value="${encodeURIComponent(value)}">
                                    <img src="${previewUrl}" alt="${header}" class="image-preview" 
                                         onerror="this.src='https://via.placeholder.com/100x80?text=External+Link'"
                                         onclick="openExternalLinkModal('${row.id}', '${header}', '${encodeURIComponent(value)}')">
                                    <div class="external-link-icon" title="External Link">üîó</div>
                                    <div class="image-actions">
                                        <button class="image-action-btn" onclick="viewImage('${fullImageUrl}')">View</button>
                                        <button class="image-action-btn" onclick="openExternalLinkModal('${row.id}', '${header}', '${encodeURIComponent(value)}')">Edit</button>
                                        <button class="image-action-btn delete" onclick="deleteImage('${row.id}', '${header}')">Delete</button>
                                    </div>
                                </td>`;
                            } else {
                                // Server image - show upload modal
                                html += `<td class="image-cell" 
                                         data-id="${row.id}" 
                                         data-field="${header}" 
                                         data-value="${encodeURIComponent(value)}">
                                    <img src="${fullImageUrl}" alt="${header}" class="image-preview" 
                                         onclick="openImageModal('${row.id}', '${header}', '${encodeURIComponent(value)}')">
                                    <div class="image-actions">
                                        <button class="image-action-btn" onclick="viewImage('${fullImageUrl}')">View</button>
                                        <button class="image-action-btn" onclick="openImageModal('${row.id}', '${header}', '${encodeURIComponent(value)}')">Edit</button>
                                        <button class="image-action-btn delete" onclick="deleteImage('${row.id}', '${header}')">Delete</button>
                                    </div>
                                </td>`;
                            }
                        } else {
                            // No image - show "Add Image" button (opens upload modal)
                            html += `<td class="image-cell" 
                                     data-id="${row.id}" 
                                     data-field="${header}" 
                                     data-value="">
                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 12px;">
                                    <button class="image-action-btn" onclick="openImageModal('${row.id}', '${header}', '')" 
                                            style="background: #4CAF50; color: white;">Add Image</button>
                                </div>
                            </td>`;
                        }
                    } else if (header === 'status') {
                        if (isActive) {
                            cellStyle = 'color: #4CAF50; font-weight: bold;';
                            displayValue = `${value} (Active)`;
                        } else {
                            cellStyle = 'color: #f44336; font-weight: bold;';
                            displayValue = `${value} (Inactive)`;
                        }
                        
                        const truncatedValue = displayValue.substring(0, 50);
                        const isTruncated = displayValue.length > 50;
                        const titleText = displayValue.length > 50 ? displayValue : '';
                        
                        html += `<td class="editable" 
                                 title="${titleText}\n\nClick to edit ${header}" 
                                 data-id="${row.id}" 
                                 data-field="${header}" 
                                 data-value="${encodeURIComponent(value)}"
                                 onclick="openFieldEditModal(this)"
                                 style="${cellStyle}">
                            ${isTruncated ? truncatedValue + '...' : truncatedValue}
                        </td>`;
                    } else if (header === 'priority') {
                        // Show original priority if it's an outlier
                        if (isOutlier) {
                            cellStyle = 'color: #9E9E9E; font-weight: bold;';
                            displayValue = `${originalPriority || value}`;
                        } else if (priority >= 1 && priority <= 3) {
                            cellStyle = 'color: #2E7D32; font-weight: bold;';
                            displayValue = `${value}`;
                        } else if (priority >= 4 && priority <= 6) {
                            cellStyle = 'color: #2196F3; font-weight: bold;';
                            displayValue = `${value}`;
                        } else if (priority >= 7 && priority <= 9) {
                            cellStyle = 'color: #FF9800; font-weight: bold;';
                            displayValue = `${value}`;
                        } else if (priority === 10) {
                            cellStyle = 'color: #757575; font-weight: bold;';
                            displayValue = `${value}`;
                        }
                        
                        const truncatedValue = displayValue.substring(0, 50);
                        const isTruncated = displayValue.length > 50;
                        const titleText = displayValue.length > 50 ? displayValue : '';
                        
                        html += `<td class="editable" 
                                 title="${titleText}\n\nClick to edit ${header}" 
                                 data-id="${row.id}" 
                                 data-field="${header}" 
                                 data-value="${encodeURIComponent(value)}"
                                 onclick="openFieldEditModal(this)"
                                 style="${cellStyle}">
                            ${isTruncated ? truncatedValue + '...' : truncatedValue}
                        </td>`;
                    } else if (header === 'version') {
                        // NEW: Style version column
                        if (version >= 1 && version <= 10) {
                            cellStyle = 'color: #7B1FA2; font-weight: bold;';
                            displayValue = `${value}`;
                        }
                        
                        const truncatedValue = displayValue.substring(0, 50);
                        const isTruncated = displayValue.length > 50;
                        const titleText = displayValue.length > 50 ? displayValue : '';
                        
                        html += `<td class="editable" 
                                 title="${titleText}\n\nClick to edit ${header}" 
                                 data-id="${row.id}" 
                                 data-field="${header}" 
                                 data-value="${encodeURIComponent(value)}"
                                 onclick="openFieldEditModal(this)"
                                 style="${cellStyle}">
                            ${isTruncated ? truncatedValue + '...' : truncatedValue}
                        </td>`;
                    } else {
                        // Regular text field
                        // Highlight search term in results
                        if (searchTerm.trim() !== '' && typeof value === 'string') {
                            const searchLower = searchTerm.toLowerCase();
                            const valueLower = value.toLowerCase();
                            if (valueLower.includes(searchLower)) {
                                const regex = new RegExp(`(${searchTerm})`, 'gi');
                                displayValue = String(value).replace(regex, '<mark>$1</mark>');
                                cellStyle += 'background: #fff9c4;';
                            }
                        }
                        
                        const truncatedValue = displayValue.substring(0, 50);
                        const isTruncated = displayValue.length > 50;
                        const titleText = displayValue.length > 50 ? displayValue : '';
                        
                        html += `<td class="editable" 
                                 title="${titleText}\n\nClick to edit ${header}" 
                                 data-id="${row.id}" 
                                 data-field="${header}" 
                                 data-value="${encodeURIComponent(value)}"
                                 onclick="openFieldEditModal(this)"
                                 style="${cellStyle}">
                            ${isTruncated ? truncatedValue + '...' : truncatedValue}
                        </td>`;
                    }
                });
                html += '</tr>';
            });
            
            html += '</table>';
            
            // Keep cache info at top
            const existingCache = container.querySelector('.cache-info');
            if (existingCache) {
                container.innerHTML = '';
                container.appendChild(existingCache);
                container.insertAdjacentHTML('beforeend', html);
            } else {
                container.innerHTML = html;
            }
        }
        
        function sortByColumn(column) {
            if (column === 'priority') {
                // Toggle priority order
                const orders = ['asc', 'desc', 'outliers'];
                const currentIndex = orders.indexOf(priorityOrder);
                priorityOrder = orders[(currentIndex + 1) % orders.length];
                document.getElementById('priorityOrder').value = priorityOrder;
                sortByPriority = true;
                applyFilter();
            } else if (column === 'version') {
                // NEW: Sort by version
                const sortedData = [...filteredData].sort((a, b) => {
                    const versionA = Number(a.version) || 1;
                    const versionB = Number(b.version) || 1;
                    return versionA - versionB; // Ascending by version
                });
                filteredData = sortedData;
                displayCurrentPage();
                showMessage('Sorted by Version (ascending)', 'info');
            } else if (column === 'id') {
                // Sort by id
                const sortedData = [...filteredData].sort((a, b) => (b.id || 0) - (a.id || 0));
                filteredData = sortedData;
                displayCurrentPage();
                showMessage('Sorted by ID (descending)', 'info');
            } else if (column === 'status') {
                // Sort by status (active first, then inactive) - use isActive flag
                const sortedData = [...filteredData].sort((a, b) => {
                    const aActive = a.isActive === true ? 1 : 0;
                    const bActive = b.isActive === true ? 1 : 0;
                    return bActive - aActive; // active first
                });
                filteredData = sortedData;
                displayCurrentPage();
                showMessage('Sorted by Status (active first)', 'info');
            } else {
                // Sort by other columns alphabetically
                const sortedData = [...filteredData].sort((a, b) => {
                    const aVal = String(a[column] || '').toLowerCase();
                    const bVal = String(b[column] || '').toLowerCase();
                    return aVal.localeCompare(bVal);
                });
                filteredData = sortedData;
                displayCurrentPage();
                showMessage(`Sorted by ${column}`, 'info');
            }
            
            updatePaginationControls();
        }
        
        // Edit Modal Functions
        function openFieldEditModal(cell) {
            const id = cell.getAttribute('data-id');
            const field = cell.getAttribute('data-field');
            const value = decodeURIComponent(cell.getAttribute('data-value') || '');
            
            // Check if this is an image field
            if (isImageField(field)) {
                if (value && isExternalLink(value)) {
                    openExternalLinkModal(id, field, value);
                } else {
                    openImageModal(id, field, value);
                }
                return;
            }
            
            currentEditId = id;
            currentEditField = field;
            originalValue = value;
            
            // Set field name and info
            const displayField = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            document.getElementById('fieldName').textContent = `Editing ${displayField}`;
            document.getElementById('fieldLabel').textContent = displayField;
            document.getElementById('fieldInfo').textContent = `Gallery ID: ${id}`;
            
            // Create appropriate input based on field type
            const fieldInput = document.getElementById('fieldInput');
            fieldInput.innerHTML = '';
            
            let inputHtml = '';
            
            // Determine input type based on field name and value
            if (field.toLowerCase().includes('description') || 
                field.toLowerCase().includes('bio') ||
                field.toLowerCase().includes('content') ||
                (String(value).length > 100 && !field.toLowerCase().includes('image'))) {
                // Textarea for long text
                inputHtml = `
                    <textarea id="editValue" name="${field}" class="form-control" rows="4" 
                              placeholder="Enter ${displayField.toLowerCase()}...">${value}</textarea>
                `;
            } else if (field.toLowerCase().includes('status')) {
                // Select dropdown for status with common string values
                const statusOptions = [
                    'active', 'inactive', 'enabled', 'disabled', 
                    'on', 'off', 'yes', 'no', 'true', 'false'
                ];
                let optionsHtml = '';
                statusOptions.forEach(option => {
                    const selected = value.toLowerCase() === option ? 'selected' : '';
                    const displayOption = option.charAt(0).toUpperCase() + option.slice(1);
                    optionsHtml += `<option value="${option}" ${selected}>${displayOption}</option>`;
                });
                
                inputHtml = `
                    <select id="editValue" name="${field}" class="form-control">
                        ${optionsHtml}
                        <option value="" ${!value ? 'selected' : ''}>-- Select Status --</option>
                    </select>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        Note: Common active values: active, enabled, on, yes, true
                    </div>
                `;
            } else if (field.toLowerCase().includes('priority')) {
                // Number input for priority (1-10)
                const priorityValue = parseInt(value) || 1;
                inputHtml = `
                    <input type="number" id="editValue" name="${field}" value="${priorityValue}" 
                           class="form-control" min="1" max="10" step="1">
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        <div>Priority 1-3: <span style="color: #2E7D32;">High</span></div>
                        <div>Priority 4-6: <span style="color: #2196F3;">Medium</span></div>
                        <div>Priority 7-9: <span style="color: #FF9800;">Low</span></div>
                        <div>Priority 10: <span style="color: #757575;">Lowest</span></div>
                    </div>
                `;
            } else if (field.toLowerCase().includes('version')) {
                // NEW: Number input for version (1-10)
                const versionValue = parseInt(value) || 1;
                inputHtml = `
                    <input type="number" id="editValue" name="${field}" value="${versionValue}" 
                           class="form-control" min="1" max="10" step="1">
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        Version indicates the app version this gallery belongs to (1-10)
                    </div>
                `;
            } else {
                // Default text input
                inputHtml = `
                    <input type="text" id="editValue" name="${field}" value="${value}" 
                           class="form-control" placeholder="Enter ${displayField.toLowerCase()}...">
                `;
            }
            
            fieldInput.innerHTML = inputHtml;
            
            // Focus on the input
            setTimeout(() => {
                const input = document.getElementById('editValue');
                if (input) input.focus();
            }, 100);
            
            // Show modal
            document.getElementById('editModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditId = null;
            currentEditField = null;
            originalValue = null;
        }
        
        async function handleEditSubmit(e) {
            e.preventDefault();
            
            const input = document.getElementById('editValue');
            let newValue = input.value.trim();
            
            // Convert empty string to null for database
            if (newValue === '') {
                newValue = null;
            }
            
            // Check if value actually changed
            if (JSON.stringify(newValue) === JSON.stringify(originalValue)) {
                showMessage('‚ÑπÔ∏è No changes detected', 'info');
                closeModal();
                return;
            }
            
            try {
                showMessage('üîÑ Saving changes...', 'info');
                
                const updateData = {};
                updateData[currentEditField] = newValue;
                
                const response = await fetch(`/api/galleries/${currentEditId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ Field updated successfully!', 'success');
                    
                    // Update the specific cell in the table
                    updateTableCell(currentEditId, currentEditField, newValue);
                    
                    // Update the allData array
                    const galleryIndex = allData.findIndex(gallery => gallery.id == currentEditId);
                    if (galleryIndex !== -1) {
                        allData[galleryIndex][currentEditField] = newValue;
                        
                        // If updating status, update isActive flag
                        if (currentEditField === 'status') {
                            const statusStr = String(newValue || '').toLowerCase().trim();
                            allData[galleryIndex].isActive = (
                                statusStr === 'on' || 
                                statusStr === 'active' || 
                                statusStr === 'true' || 
                                statusStr === '1' || 
                                statusStr === 'yes' ||
                                statusStr === 'enabled'
                            );
                        } else if (currentEditField === 'priority') {
                            const priority = Number(newValue) || 1;
                            const isOutlier = priority < 1 || priority > 10;
                            allData[galleryIndex].priority = priority;
                            allData[galleryIndex].isOutlier = isOutlier;
                        } else if (currentEditField === 'version') {
                            // NEW: Update version
                            const version = Number(newValue) || 1;
                            allData[galleryIndex].version = version;
                        }
                        
                        // Reapply filters to update stats
                        applyFilter();
                        updateStats();
                        updatePriorityStats();
                        updateVersionStats(); // NEW: Update version stats
                    }
                    
                    setTimeout(() => {
                        closeModal();
                    }, 1000);
                } else {
                    showMessage(`‚ùå Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`‚ùå Network error: ${error.message}`, 'error');
            }
        }
        
        function updateTableCell(id, field, newValue) {
            // Find and update the specific cell
            const cells = document.querySelectorAll(`td[data-id="${id}"][data-field="${field}"]`);
            cells.forEach(cell => {
                let displayValue = newValue;
                if (displayValue === null || displayValue === undefined) displayValue = '';
                if (typeof displayValue === 'object') {
                    try {
                        displayValue = JSON.stringify(displayValue);
                    } catch (e) {
                        displayValue = String(displayValue);
                    }
                }
                
                // Format display value based on field type
                if (field === 'status') {
                    const statusStr = String(displayValue).toLowerCase().trim();
                    const isActive = (
                        statusStr === 'on' || 
                        statusStr === 'active' || 
                        statusStr === 'true' || 
                        statusStr === '1' || 
                        statusStr === 'yes' ||
                        statusStr === 'enabled'
                    );
                    displayValue = `${displayValue} (${isActive ? 'Active' : 'Inactive'})`;
                } else if (field === 'priority') {
                    const priority = Number(displayValue) || 1;
                    if (priority < 1 || priority > 10) {
                        displayValue = `${priority} (Outlier)`;
                    } else {
                        displayValue = `${priority}`;
                    }
                } else if (field === 'version') {
                    // NEW: Format version display
                    const version = Number(displayValue) || 1;
                    displayValue = `${version}`;
                }
                
                const truncatedValue = String(displayValue).substring(0, 50);
                const isTruncated = String(displayValue).length > 50;
                
                cell.textContent = truncatedValue + (isTruncated ? '...' : '');
                cell.setAttribute('data-value', encodeURIComponent(newValue));
                cell.setAttribute('title', `${displayValue}\n\nClick to edit ${field}`);
                
                // Add visual feedback
                cell.style.background = '#d4edda';
                cell.style.transition = 'background 0.5s';
                
                setTimeout(() => {
                    cell.style.background = '';
                }, 1000);
            });
        }
        
        // Image Upload Modal Functions
        function openImageModal(id, field, value) {
            currentImageId = id;
            currentImageField = field;
            currentImageUrl = decodeURIComponent(value || '');
            
            // Set modal title
            const displayField = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            document.getElementById('imageModalTitle').textContent = `Edit ${displayField}`;
            document.getElementById('imageFieldName').textContent = displayField;
            document.getElementById('imageFieldInfo').textContent = `Gallery ID: ${id}`;
            
            // Show/hide current image section
            const currentImageContainer = document.getElementById('currentImageContainer');
            const currentImagePreview = document.getElementById('currentImagePreview');
            const currentImageActions = document.getElementById('currentImageActions');
            
            if (currentImageUrl && currentImageUrl.trim() !== '') {
                const fullImageUrl = getFullImageUrl(currentImageUrl);
                currentImagePreview.src = fullImageUrl;
                currentImagePreview.alt = displayField;
                currentImagePreview.onerror = function() {
                    this.src = 'https://via.placeholder.com/200x150?text=Image+Not+Found';
                };
                currentImageContainer.style.display = 'block';
                currentImageActions.style.display = 'block';
            } else {
                currentImageContainer.style.display = 'none';
                currentImageActions.style.display = 'none';
            }
            
            // Reset upload section
            resetUploadSection();
            
            // Show modal
            document.getElementById('imageUploadModal').style.display = 'block';
            
            // Setup drag and drop
            setupDragAndDrop();
        }
        
        function closeImageModal() {
            document.getElementById('imageUploadModal').style.display = 'none';
            currentImageId = null;
            currentImageField = null;
            currentImageUrl = null;
            uploadedImageUrl = null;
            uploadedFile = null;
        }
        
        function viewCurrentImage() {
            if (currentImageUrl) {
                const fullImageUrl = getFullImageUrl(currentImageUrl);
                window.open(fullImageUrl, '_blank');
            }
        }
        
        function deleteCurrentImage() {
            if (confirm('Are you sure you want to delete this image?')) {
                saveImageToServer('');
            }
        }
        
        function setupDragAndDrop() {
            const uploadContainer = document.getElementById('uploadContainer');
            const fileInput = document.getElementById('imageFileInput');
            
            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadContainer.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            // Highlight drop zone when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadContainer.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadContainer.addEventListener(eventName, unhighlight, false);
            });
            
            // Handle dropped files
            uploadContainer.addEventListener('drop', handleDrop, false);
            
            // Handle file input change
            fileInput.addEventListener('change', handleFileSelect, false);
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight() {
                uploadContainer.classList.add('dragover');
            }
            
            function unhighlight() {
                uploadContainer.classList.remove('dragover');
            }
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }
            
            function handleFileSelect(e) {
                const files = e.target.files;
                handleFiles(files);
            }
        }
        
        function handleFiles(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            
            // Validate file type
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showMessage('‚ùå Please select a valid image file (JPG, PNG, GIF, WEBP)', 'error');
                return;
            }
            
            // Validate file size (10MB max - matching App Configs)
            if (file.size > 10 * 1024 * 1024) {
                showMessage('‚ùå Image size must be less than 10MB', 'error');
                return;
            }
            
            uploadedFile = file;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('uploadedImagePreview');
                preview.src = e.target.result;
                document.getElementById('imagePreviewContainer').style.display = 'flex';
                document.getElementById('saveImageBtn').disabled = false;
            };
            reader.readAsDataURL(file);
            
            // Upload the file
            uploadImage(file);
        }
        
        async function uploadImage(file) {
            try {
                console.log('üì§ Uploading image to Hostinger...', file.name, file.type);
                
                const formData = new FormData();
                formData.append('image', file);
                
                const response = await fetch('https://api.zulushop.in/api/v1/user/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const responseText = await response.text();
                console.log('Upload response text:', responseText);
                
                // Update progress bar
                document.getElementById('progressFill').style.width = '100%';
                
                if (response.status >= 200 && response.status < 300) {
                    let jsonRes;
                    try {
                        jsonRes = JSON.parse(responseText);
                    } catch (e) {
                        console.error('Failed to parse JSON response:', e);
                        throw new Error('Invalid response from server');
                    }
                    
                    // Extract URL from response
                    let url;
                    
                    // Try different possible response formats
                    if (jsonRes.url && typeof jsonRes.url === 'string') {
                        url = jsonRes.url;
                    } else if (jsonRes.image_url && typeof jsonRes.image_url === 'string') {
                        url = jsonRes.image_url;
                    } else if (jsonRes.data) {
                        if (typeof jsonRes.data === 'string') {
                            url = jsonRes.data;
                        } else if (typeof jsonRes.data === 'object') {
                            if (jsonRes.data.url && typeof jsonRes.data.url === 'string') {
                                url = jsonRes.data.url;
                            } else if (jsonRes.data.image_url && typeof jsonRes.data.image_url === 'string') {
                                url = jsonRes.data.image_url;
                            }
                        }
                    }
                    
                    if (url) {
                        console.log('‚úÖ Image uploaded successfully. URL:', url);
                        uploadedImageUrl = url;
                        
                        // Show uploaded URL
                        document.getElementById('uploadedUrlText').textContent = url;
                        document.getElementById('uploadedUrlLink').href = url;
                        document.getElementById('uploadedUrl').style.display = 'block';
                        
                        showMessage('‚úÖ Image uploaded successfully!', 'success');
                        return url;
                    } else {
                        console.error('‚ùå No URL found in response:', jsonRes);
                        throw new Error('No image URL in response');
                    }
                } else {
                    console.error('‚ùå Upload failed with status:', response.status);
                    throw new Error(`Upload failed: ${response.status} ${responseText}`);
                }
            } catch (error) {
                console.error('‚ùå Upload error:', error);
                showMessage(`‚ùå Upload failed: ${error.message}`, 'error');
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('imagePreviewContainer').style.display = 'none';
                document.getElementById('saveImageBtn').disabled = true;
                throw error;
            }
        }
        
        function removeUploadedImage() {
            uploadedImageUrl = null;
            uploadedFile = null;
            document.getElementById('imagePreviewContainer').style.display = 'none';
            document.getElementById('uploadedUrl').style.display = 'none';
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('saveImageBtn').disabled = true;
            document.getElementById('imageFileInput').value = '';
        }
        
        function resetUploadSection() {
            removeUploadedImage();
            document.getElementById('saveImageBtn').disabled = true;
        }
        
        function saveImage() {
            if (uploadedImageUrl) {
                saveImageToServer(uploadedImageUrl);
            } else {
                showMessage('‚ùå Please upload an image first', 'error');
            }
        }
        
        async function saveImageToServer(imageUrl) {
            try {
                showMessage('üîÑ Saving image...', 'info');
                
                const updateData = {};
                updateData[currentImageField] = imageUrl;
                
                const response = await fetch(`/api/galleries/${currentImageId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ Image saved successfully!', 'success');
                    
                    // Update the allData array
                    const galleryIndex = allData.findIndex(gallery => gallery.id == currentImageId);
                    if (galleryIndex !== -1) {
                        allData[galleryIndex][currentImageField] = imageUrl;
                    }
                    
                    // Reload data to refresh the table
                    loadData();
                    
                    setTimeout(() => {
                        closeImageModal();
                    }, 1000);
                } else {
                    showMessage(`‚ùå Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`‚ùå Network error: ${error.message}`, 'error');
            }
        }
        
        async function deleteImage(id, field) {
            if (!confirm('Are you sure you want to delete this image?')) {
                return;
            }
            
            try {
                showMessage('üîÑ Deleting image...', 'info');
                
                const updateData = {};
                updateData[field] = '';
                
                const response = await fetch(`/api/galleries/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ Image deleted successfully!', 'success');
                    
                    // Update the allData array
                    const galleryIndex = allData.findIndex(gallery => gallery.id == id);
                    if (galleryIndex !== -1) {
                        allData[galleryIndex][field] = '';
                    }
                    
                    // Reload data to refresh the table
                    loadData();
                } else {
                    showMessage(`‚ùå Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`‚ùå Network error: ${error.message}`, 'error');
            }
        }
        
        function viewImage(url) {
            window.open(url, '_blank');
        }
        
        // External Link Modal Functions
        function openExternalLinkModal(id, field, value) {
            currentExternalLinkId = id;
            currentExternalLinkField = field;
            currentExternalLinkUrl = decodeURIComponent(value || '');
            
            // Set modal title
            const displayField = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            document.getElementById('externalLinkModalTitle').textContent = `Edit External Link`;
            document.getElementById('externalLinkFieldName').textContent = displayField;
            document.getElementById('externalLinkFieldInfo').textContent = `Gallery ID: ${id}`;
            
            // Show current link
            document.getElementById('currentExternalLink').textContent = currentExternalLinkUrl || 'No link';
            
            // Set URL input value
            document.getElementById('externalLinkUrl').value = currentExternalLinkUrl || '';
            
            // Show modal
            document.getElementById('externalLinkModal').style.display = 'block';
        }
        
        function closeExternalLinkModal() {
            document.getElementById('externalLinkModal').style.display = 'none';
            currentExternalLinkId = null;
            currentExternalLinkField = null;
            currentExternalLinkUrl = null;
        }
        
        function viewExternalLink() {
            if (currentExternalLinkUrl) {
                window.open(currentExternalLinkUrl, '_blank');
            }
        }
        
        function deleteExternalLink() {
            if (confirm('Are you sure you want to delete this external link?')) {
                saveExternalLinkToServer('');
            }
        }
        
        async function saveExternalLinkToServer(url) {
            try {
                showMessage('üîÑ Saving external link...', 'info');
                
                const updateData = {};
                updateData[currentExternalLinkField] = url;
                
                const response = await fetch(`/api/galleries/${currentExternalLinkId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ External link saved successfully!', 'success');
                    
                    // Update the allData array
                    const galleryIndex = allData.findIndex(gallery => gallery.id == currentExternalLinkId);
                    if (galleryIndex !== -1) {
                        allData[galleryIndex][currentExternalLinkField] = url;
                    }
                    
                    // Reload data to refresh the table
                    loadData();
                    
                    setTimeout(() => {
                        closeExternalLinkModal();
                    }, 1000);
                } else {
                    showMessage(`‚ùå Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`‚ùå Network error: ${error.message}`, 'error');
            }
        }
        
        // External link form submission
        document.getElementById('externalLinkForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const urlInput = document.getElementById('externalLinkUrl');
            const newUrl = urlInput.value.trim();
            
            // Check if value actually changed
            if (newUrl === currentExternalLinkUrl) {
                showMessage('‚ÑπÔ∏è No changes detected', 'info');
                closeExternalLinkModal();
                return;
            }
            
            await saveExternalLinkToServer(newUrl);
        });
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                    <span style="font-size: 24px;">‚ö†Ô∏è</span>
                    <div>${message}</div>
                </div>
            `;
        }
        
        function showMessage(text, type = 'success') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            
            const colors = {
                success: { bg: '#d4edda', text: '#155724', border: '#c3e6cb' },
                error: { bg: '#f8d7da', text: '#721c24', border: '#f5c6cb' },
                info: { bg: '#d1ecf1', text: '#0c5460', border: '#bee5eb' }
            };
            
            const color = colors[type] || colors.success;
            messageDiv.style.background = color.bg;
            messageDiv.style.color = color.text;
            messageDiv.style.border = `1px solid ${color.border}`;
            messageDiv.style.opacity = '1';
            
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => {
                    messageDiv.textContent = '';
                }, 300);
            }, 3000);
        }
        
        // Add event listener for edit form submission
        document.getElementById('editForm').addEventListener('submit', handleEditSubmit);
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const imageModal = document.getElementById('imageUploadModal');
            const externalModal = document.getElementById('externalLinkModal');
            
            if (event.target === editModal) {
                closeModal();
            }
            if (event.target === imageModal) {
                closeImageModal();
            }
            if (event.target === externalModal) {
                closeExternalLinkModal();
            }
        };
        
        // Close modals with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
                closeImageModal();
                closeExternalLinkModal();
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            // Set default states
            document.getElementById('statusFilter').checked = (statusFilter === 'active');
            document.getElementById('priorityOrder').value = priorityOrder;
            document.getElementById('showOutliers').checked = showOutliers;
            document.getElementById('priorityFilter').value = priorityFilter;
            document.getElementById('versionFilter').value = versionFilter; // NEW: Set version filter
            document.getElementById('pageSize').value = pageSize;
            
            updateFilterButton();
            updateSortButton();
            updateStatusButtons();
            loadData();
        });
        
function enableFloatingScrollbar(targetSelector) {
    const target = document.querySelector(targetSelector);
    if (!target) return;

    // Avoid duplicate scrollbar
    if (document.getElementById('__floating_scrollbar__')) return;

    const floating = document.createElement('div');
    floating.id = '__floating_scrollbar__';
    floating.style.position = 'fixed';
    floating.style.bottom = '0';
    floating.style.left = '0';
    floating.style.right = '0';
    floating.style.height = '16px';
    floating.style.overflowX = 'auto';
    floating.style.overflowY = 'hidden';
    floating.style.zIndex = '9999';

    const inner = document.createElement('div');
    inner.style.height = '1px';

    floating.appendChild(inner);
    document.body.appendChild(floating);

    function sync() {
        // Always match real scroll width
        const width = target.scrollWidth;
        inner.style.width = width + 'px';

        // Keep scroll positions aligned
        if (floating.scrollLeft !== target.scrollLeft) {
            floating.scrollLeft = target.scrollLeft;
        }
    }

    // Bidirectional sync
    floating.addEventListener('scroll', () => {
        target.scrollLeft = floating.scrollLeft;
    });

    target.addEventListener('scroll', () => {
        floating.scrollLeft = target.scrollLeft;
    });

    // üîë AUTO-FIX EVERYTHING
    new ResizeObserver(sync).observe(target);
    new MutationObserver(sync).observe(target, {
        childList: true,
        subtree: true,
        attributes: true
    });

    window.addEventListener('resize', sync);

    // Run continuously until layout stabilizes
    requestAnimationFrame(function loop() {
        sync();
        requestAnimationFrame(loop);
    });
}
enableFloatingScrollbar('#dataContainer');
    </script>
</body>
</html>
