<!DOCTYPE html>
<html>
<head>
    <title>Products - Card View</title>
    <style>
        /* CSS remains mostly the same, just adding a few optimizations */
        :root {
            --primary-color: #3498db;
            --success-color: #27ae60;
            --error-color: #e74c3c;
            --warning-color: #f39c12;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --bg-light: #f5f7fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 30px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
            margin-bottom: 25px;
            font-size: 28px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        h1:before {
            content: "üì¶";
            font-size: 32px;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
            align-items: center;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        button {
            padding: 12px 24px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        button:active {
            transform: translateY(0);
        }
        .back-btn {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }
        .back-btn:hover {
            background: linear-gradient(135deg, #5a6268 0%, #4a5056 100%);
        }
        .refresh-btn {
            background: linear-gradient(135deg, #2196F3 0%, #0b7dda 100%);
            color: white;
        }
        .refresh-btn:hover {
            background: linear-gradient(135deg, #0b7dda 0%, #0969b8 100%);
        }
        .search-box {
            flex-grow: 1;
            max-width: 400px;
            position: relative;
        }
        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        .search-box input:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .search-box:after {
            content: "üîç";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
        }
        
        .filters-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e8e8e8;
        }
        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .filter-group {
            position: relative;
        }
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        .filter-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237f8c8d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 15px;
        }
        .filter-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .filter-count {
            display: inline-block;
            margin-left: 8px;
            padding: 4px 10px;
            background: #3498db;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }
        
        #message {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 600;
            text-align: center;
            display: none;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        #loading {
            padding: 30px;
            text-align: center;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            margin: 25px 0;
            color: #856404;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        #loading:before {
            content: "‚è≥";
            font-size: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #error {
            padding: 25px;
            text-align: center;
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 2px solid #f5c6cb;
            border-radius: 10px;
            margin: 25px 0;
            color: #721c24;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 25px;
            margin-top: 25px;
        }
        
        @media (max-width: 1600px) {
            .products-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 1200px) {
            .products-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 800px) {
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 500px) {
            .products-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid #f0f0f0;
        }
        
        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        .card-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: all 0.5s ease;
            opacity: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .card-image img.loaded {
            opacity: 1;
        }
        
        .product-card:hover .card-image img {
            transform: scale(1.1);
        }
        
        .image-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: all 0.3s;
        }
        
        .product-card:hover .image-actions {
            opacity: 1;
        }
        
        .image-action-btn {
            background: rgba(255,255,255,0.95);
            color: #2c3e50;
            border: none;
            border-radius: 6px;
            padding: 8px 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .image-action-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .card-content {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            min-height: 44px;
        }
        
        .card-id {
            font-size: 12px;
            color: #7f8c8d;
            background: #f8f9fa;
            padding: 6px 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            margin-bottom: 12px;
            display: inline-block;
            border: 1px solid #e8e8e8;
        }
        
        .card-prices {
            margin: 15px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e8e8e8;
        }
        
        .original-price {
            font-size: 14px;
            color: #95a5a6;
            text-decoration: line-through;
            margin-right: 10px;
        }
        
        .special-price {
            font-size: 18px;
            font-weight: 700;
            color: #e74c3c;
        }
        
        .normal-price {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .card-info {
            margin-top: 15px;
            font-size: 12px;
            color: #666;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .info-tag {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
            padding: 6px 12px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(21, 101, 192, 0.1);
            font-weight: 600;
        }
        
        .info-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .info-tag.seller {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: #2e7d32;
        }
        
        .info-tag.category {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            color: #7b1fa2;
        }
        
        .info-tag.status.active {
            background: linear-gradient(135deg, #4CAF50 0%, #388e3c 100%);
            color: white;
        }
        
        .info-tag.status.inactive {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }
        
        .info-tag.edit {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            cursor: pointer;
        }
        
        .info-tag.ai {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
        }
        
        .info-tag.music {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            cursor: pointer;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: #7f8c8d;
            font-size: 18px;
            grid-column: 1 / -1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 2px dashed #e0e0e0;
        }
        
        .empty-state:before {
            content: "üì¶";
            font-size: 48px;
            display: block;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 2px solid #f0f0f0;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border-radius: 16px 16px 0 0;
        }
        
        .modal-header h2 {
            margin: 0;
            color: white;
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-header h2:before {
            content: "‚úèÔ∏è";
            font-size: 24px;
        }
        
        .close-modal {
            background: rgba(255,255,255,0.2);
            border: none;
            font-size: 32px;
            cursor: pointer;
            color: white;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .close-modal:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .field-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            border-left: 6px solid #3498db;
            border-right: 1px solid #e0e0e0;
            border-top: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .field-info h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
        }
        
        .field-info p {
            margin: 0;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
        }
        
        .form-section h4 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
            padding-bottom: 12px;
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-section h4:before {
            content: "üìã";
            font-size: 18px;
        }
        
        .form-group {
            margin-bottom: 25px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group label:after {
            content: ":";
            color: #3498db;
        }
        
        .form-control {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            box-sizing: border-box;
            transition: all 0.3s;
            background: white;
            font-family: inherit;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.15);
            transform: translateY(-2px);
        }
        
        .form-control:hover {
            border-color: #bdc3c7;
        }
        
        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237f8c8d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 18px center;
            background-size: 16px;
            padding-right: 50px;
        }
        
        .price-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .price-group .form-group {
            margin-bottom: 0;
        }
        
        .price-field {
            position: relative;
        }
        
        .price-field:before {
            content: "‚Çπ";
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #3498db;
            font-weight: bold;
            font-size: 16px;
        }
        
        .price-field .form-control {
            padding-left: 40px;
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
            line-height: 1.6;
        }
        
        .form-control[readonly] {
            background: #f8f9fa;
            color: #7f8c8d;
            cursor: not-allowed;
        }
        
        .form-control[readonly]:focus {
            border-color: #e0e0e0;
            box-shadow: none;
            transform: none;
        }
        
        .validation-feedback {
            display: none;
            margin-top: 8px;
            font-size: 12px;
            padding: 8px 12px;
            border-radius: 6px;
        }
        
        .validation-feedback.valid {
            display: block;
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .validation-feedback.invalid {
            display: block;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding: 25px 30px;
            border-top: 2px solid #f0f0f0;
            background: #f8f9fa;
            border-radius: 0 0 16px 16px;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
            color: white;
            padding: 14px 28px;
            font-size: 15px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .save-btn:hover {
            background: linear-gradient(135deg, #219653 0%, #1e874b 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
        }
        
        .save-btn:active {
            transform: translateY(0);
        }
        
        .cancel-btn {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
            padding: 14px 28px;
            font-size: 15px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .cancel-btn:hover {
            background: linear-gradient(135deg, #7f8c8d 0%, #6c757d 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(127, 140, 141, 0.3);
        }
        
        .cancel-btn:active {
            transform: translateY(0);
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-indicator.active {
            background: rgba(39, 174, 96, 0.1);
            color: #27ae60;
            border: 1px solid rgba(39, 174, 96, 0.2);
        }
        
        .status-indicator.active:before {
            content: "‚óè";
            color: #27ae60;
            font-size: 8px;
        }
        
        .status-indicator.inactive {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.2);
        }
        
        .status-indicator.inactive:before {
            content: "‚óè";
            color: #e74c3c;
            font-size: 8px;
        }
        
        .required:after {
            content: " *";
            color: #e74c3c;
        }
        
        .field-description {
            display: block;
            margin-top: 6px;
            font-size: 12px;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .form-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            z-index: 10;
        }
        
        .form-loading:before {
            content: "";
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .form-success {
            animation: successPulse 0.6s ease;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .price-group {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .modal-content {
                width: 95%;
                max-height: 85vh;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .form-section {
                padding: 20px;
            }
            
            .modal-actions {
                flex-direction: column-reverse;
                gap: 10px;
            }
            
            .save-btn, .cancel-btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        .current-image-container {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #ddd;
        }
        
        .current-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .upload-container {
            border: 2px dashed #2196F3;
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            background: #f8f9fa;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .upload-container.dragover {
            border-color: #4CAF50;
            background: #e8f5e9;
        }
        
        .upload-btn {
            background: #2196F3;
            color: white;
            padding: 12px 25px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .upload-btn:hover {
            background: #0b7dda;
        }
        
        .file-input {
            display: none;
        }
        
        .ai-step {
            padding: 8px 12px;
            background: #f0f0f0;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #7f8c8d;
        }
        
        .ai-step.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .ai-step.completed {
            background: #4CAF50;
            color: white;
        }
        
        .ai-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: none;
        }
        
        .lyrics-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #ff6b6b;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .instructions {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .audio-preview {
            width: 100%;
            margin: 15px 0;
            border-radius: 8px;
        }
        
        .upload-status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 600;
        }
        
        .upload-status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .upload-status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .upload-status.processing {
            background: #fff3cd;
            color: #856404;
        }
        /* Add to existing CSS */
.prompt-variable {
    background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-family: 'Courier New', monospace;
    cursor: pointer;
    margin: 2px;
    display: inline-block;
}

.prompt-variable:hover {
    background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
    transform: translateY(-1px);
}

.prompt-templates {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border: 1px solid #e0e0e0;
}

.prompt-templates h5 {
    margin: 0 0 10px 0;
    color: #2c3e50;
    font-size: 14px;
}

.preset-prompt-btn {
    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    margin: 5px 5px 5px 0;
    transition: all 0.3s;
}

.preset-prompt-btn:hover {
    background: linear-gradient(135deg, #0984e3 0%, #0767b1 100%);
    transform: translateY(-2px);
}

.prompt-info {
    background: #fff3cd;
    padding: 10px;
    border-radius: 6px;
    border-left: 4px solid #ffc107;
    font-size: 13px;
    color: #856404;
    margin: 10px 0;
}
.prompt-tab {
    transition: all 0.3s ease;
}

.prompt-tab.active {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

.prompt-tab:not(.active) {
    opacity: 0.8;
}

.prompt-tab:hover:not(.active) {
    opacity: 1;
    transform: translateY(-2px);
}
    </style>
</head>
<body>
    <h1>Products - Card View</h1>
    
<!-- Music Generation Modal -->
<div id="musicModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);">
            <h2>üéµ Generate Music for Product</h2>
            <button class="close-modal" onclick="closeMusicModal()">&times;</button>
        </div>
        
        <div class="modal-body">
            <div class="field-info">
                <h3 id="musicProductName">Product Name</h3>
                <p id="musicProductInfo">Generate lyrics and music for this product</p>
            </div>
            
            <!-- Choice Section -->
            <div id="choiceSection" style="display: none;">
                <div style="text-align: center; padding: 20px;">
                    <h3 style="margin-bottom: 25px; color: #2c3e50;">How would you like to proceed?</h3>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px; margin: 30px 0;">
                        <button onclick="editPromptsBeforeGenerate()" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            border: none;
                            padding: 18px 25px;
                            border-radius: 12px;
                            cursor: pointer;
                            font-size: 16px;
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 12px;
                            transition: all 0.3s;
                            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.2);
                        ">
                            <span style="font-size: 24px;">‚úèÔ∏è</span>
                            <div style="text-align: left;">
                                <div style="font-size: 18px;">Edit Prompts First</div>
                                <div style="font-size: 13px; opacity: 0.9; margin-top: 5px;">Edit lyrics and style prompts, then generate</div>
                            </div>
                        </button>
                        
                        <button onclick="generateImmediately()" style="
                            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
                            color: white;
                            border: none;
                            padding: 18px 25px;
                            border-radius: 12px;
                            cursor: pointer;
                            font-size: 16px;
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 12px;
                            transition: all 0.3s;
                            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.2);
                        ">
                            <span style="font-size: 24px;">‚ö°</span>
                            <div style="text-align: left;">
                                <div style="font-size: 18px;">Generate Immediately</div>
                                <div style="font-size: 13px; opacity: 0.9; margin-top: 5px;">Use default prompts to generate instantly</div>
                            </div>
                        </button>
                    </div>
                    
                    <div style="margin-top: 25px; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 2px dashed #ddd;">
                        <div style="font-size: 14px; color: #7f8c8d;">
                            <strong>Default prompts will be used for:</strong>
                            <ul style="text-align: left; margin: 10px 0 10px 20px;">
                                <li>Lyrics generation</li>
                                <li>Music style description</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Prompt Editor Section -->
            <div id="promptEditorSection" style="display: none;">
                <!-- Will be filled dynamically -->
            </div>
            
            <!-- Progress Steps -->
            <div id="musicProgress" style="margin-bottom: 30px; display: none;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <span class="ai-step" id="step1">1. Generate</span>
                    <span class="ai-step" id="step2">2. Upload</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="musicProgressBar"></div>
                </div>
            </div>
            
            <!-- Loading State -->
            <div id="musicLoading" style="text-align: center; padding: 30px; display: none;">
                <div style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #ff6b6b; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <h3 id="musicCurrentTask">Generating...</h3>
                <p id="musicTaskDetails">Please wait while we process your request</p>
            </div>
            
            <!-- Results Display -->
            <div id="resultsContent" style="display: none;">
                <!-- Lyrics Display -->
                <div id="lyricsResult" style="display: none;">
                    <h4>üé∂ Generated Lyrics</h4>
                    <div class="lyrics-container" id="generatedLyrics">
                        Lyrics will appear here...
                    </div>
                    <div style="margin-top: 10px;">
                        <button onclick="copyToClipboard('generatedLyrics')" class="image-action-btn">
                            üìã Copy Lyrics
                        </button>
                    </div>
                </div>
                
                <!-- Style Display -->
                <div id="styleResult" style="display: none;">
                    <h4>üé® Generated Style</h4>
                    <div class="style-container" id="generatedStyle">
                        Style will appear here...
                    </div>
                    <div style="margin-top: 10px;">
                        <button onclick="copyToClipboard('generatedStyle')" class="image-action-btn">
                            üìã Copy Style
                        </button>
                    </div>
                </div>
                
                <div class="instructions">
                    <strong>Instructions for Suno.ai:</strong>
                    <ol>
                        <li>Go to <a href="https://suno.ai" target="_blank">suno.ai</a></li>
                        <li>Select "Create" ‚Üí "Custom Mode"</li>
                        <li>Paste the lyrics above</li>
                        <li>Use the style description for guidance</li>
                        <li>In style settings, select: 30 seconds length</li>
                        <li>Click "Generate" and wait for the music</li>
                        <li>Download the generated music file</li>
                        <li>Upload it below</li>
                    </ol>
                </div>
                
                <!-- Music File Upload -->
                <h4>üìÅ Upload Generated Music</h4>
                <div class="upload-container" id="musicUploadContainer">
                    <input type="file" id="musicFileInput" class="file-input" accept="audio/*,.mp3,.wav,.m4a">
                    <button type="button" class="upload-btn" onclick="document.getElementById('musicFileInput').click()">
                        üéµ Choose Music File to Upload
                    </button>
                    <p style="margin: 15px 0; color: #666;">or drag and drop audio file here</p>
                    <div style="font-size: 13px; color: #7f8c8d; margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 6px;">
                        <strong>Supported formats:</strong> MP3, WAV, M4A<br>
                        <strong>Maximum file size:</strong> 10MB<br>
                        <strong>Recommended:</strong> 30-second clip from Suno.ai
                    </div>
                </div>
                
                <!-- Uploaded Music Preview -->
                <div id="musicPreviewContainer" style="display: none; text-align: center; margin: 25px 0; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px solid #e0e0e0;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50;">Uploaded Music Preview</h4>
                    <audio id="uploadedMusicPreview" class="audio-preview" controls>
                        Your browser does not support the audio element.
                    </audio>
                    <div id="uploadStatus" class="upload-status" style="margin-top: 15px;"></div>
                </div>
            </div>
            
            <!-- Error State -->
            <div id="musicError" style="display: none; text-align: center; padding: 30px;">
                <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                <h3>Generation Failed</h3>
                <p id="musicErrorMessage">Error message will appear here</p>
                <button onclick="retryGeneration()" style="margin-top: 20px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    üîÑ Retry
                </button>
            </div>
        </div>
        
        <div class="modal-actions">
            <button type="button" class="cancel-btn" onclick="closeMusicModal()">
                ‚úï Close
            </button>
            <button type="button" class="save-btn" id="saveMusicBtn" style="display: none; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);" onclick="saveMusicToProduct()">
                üíæ Save Music File
            </button>
        </div>
    </div>
</div>

    <!-- AI Results Modal -->
    <div id="aiResultsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>ü§ñ AI Processing Results</h2>
                <button class="close-modal" onclick="closeAIResultsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="aiProgress" style="margin-bottom: 30px; display: none;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span class="ai-step" id="step1">1. Image Enhance</span>
                        <span class="ai-step" id="step2">2. Category Analysis</span>
                        <span class="ai-step" id="step3">3. Tags Generation</span>
                        <span class="ai-step" id="step4">4. Description</span>
                    </div>
                    <div style="background: #f0f0f0; height: 10px; border-radius: 5px;">
                        <div id="aiProgressBar" style="width: 0%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 5px; transition: width 0.3s;"></div>
                    </div>
                </div>
                <div id="aiResultsContent">
                    <div class="field-info">
                        <h3 id="aiProductName">Product Name</h3>
                        <p id="aiProductInfo">Processing AI tasks...</p>
                    </div>
                    <div class="form-section" style="display: none;" id="aiImageResult">
                        <h4>üì∏ Enhanced Image</h4>
                        <div style="text-align: center; margin: 20px 0;">
                            <img id="aiEnhancedImage" src="" alt="Enhanced Image" style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        </div>
                        <div id="aiImageActions" style="text-align: center; margin-top: 15px;"></div>
                    </div>
                    <div class="form-section" style="display: none;" id="aiCategoryResult">
                        <h4>üìÇ Category & Cat1 Analysis</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label>Suggested Category:</label>
                                <div id="aiSuggestedCategory" style="padding: 10px; background: #f8f9fa; border-radius: 8px; margin-top: 5px;"></div>
                            </div>
                            <div>
                                <label>Suggested Cat1:</label>
                                <div id="aiSuggestedCat1" style="padding: 10px; background: #f8f9fa; border-radius: 8px; margin-top: 5px;"></div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 6px; border-left: 4px solid #4CAF50;">
                            <strong>Analysis:</strong> <span id="aiCategoryAnalysis"></span>
                        </div>
                    </div>
                    <div class="form-section" style="display: none;" id="aiTagsResult">
                        <h4>üè∑Ô∏è Generated Tags</h4>
                        <div id="aiTagsList" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>
                    </div>
                    <div class="form-section" style="display: none;" id="aiDescriptionResult">
                        <h4>üìù Description</h4>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
                            <label style="font-weight: 600; display: block; margin-bottom: 10px;">Main Description:</label>
                            <div id="aiMainDescription" style="line-height: 1.6; color: #2c3e50;"></div>
                        </div>
                        <div style="padding: 15px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #ff9800;">
                            <label style="font-weight: 600; display: block; margin-bottom: 10px;">‚ú® Extra Description:</label>
                            <div id="aiExtraDescription" style="line-height: 1.6; color: #e65100; font-style: italic;"></div>
                        </div>
                    </div>
                </div>
                <div id="aiLoading" style="text-align: center; padding: 40px;">
                    <div style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <h3 id="aiCurrentTask">Processing AI Tasks...</h3>
                    <p id="aiTaskDetails">Please wait while AI processes your product</p>
                </div>
                <div id="aiError" style="display: none; text-align: center; padding: 30px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                    <h3>AI Processing Failed</h3>
                    <p id="aiErrorMessage">Error message will appear here</p>
                    <button onclick="retryAITasks()" style="margin-top: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        üîÑ Retry
                    </button>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="cancel-btn" onclick="closeAIResultsModal()">‚úï Close</button>
                <button type="button" class="save-btn" id="aiApplyChangesBtn" style="display: none; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);" onclick="applyAIResults()">üíæ Apply All Changes</button>
            </div>
        </div>
    </div>
    
    <div class="controls">
        <button class="back-btn" onclick="location.href='/'">‚Üê Back to Dashboard</button>
        <button class="refresh-btn" onclick="loadProducts()">üîÑ Refresh</button>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search products by name, ID, or description...">
        </div>
    </div>
    
    <div class="filters-container">
        <div class="filters-row">
            <div class="filter-group">
                <label>Status: <span class="filter-count" id="statusCount">0</span></label>
                <select id="statusFilter">
                    <option value="all">All Status</option>
                    <option value="1">Active</option>
                    <option value="0">Inactive</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Category: <span class="filter-count" id="categoryCount">0</span></label>
                <select id="categoryFilter">
                    <option value="all">All Categories</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Cat1: <span class="filter-count" id="cat1Count">0</span></label>
                <select id="cat1Filter">
                    <option value="all">All Cat1</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Seller: <span class="filter-count" id="sellerCount">0</span></label>
                <select id="sellerFilter">
                    <option value="all">All Sellers</option>
                </select>
            </div>
        </div>
    </div>
    
    <div id="message"></div>
    <div id="loading">Loading products...</div>
    <div id="error"></div>
    
    <div id="productsContainer" class="products-grid"></div>

    <!-- Image Upload Modal -->
    <div id="imageUploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Product Image</h2>
                <button class="close-modal" onclick="closeImageModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="field-info">
                    <h3 id="imageFieldName">Product Image</h3>
                    <p id="imageFieldInfo">Upload or replace the product image</p>
                </div>
                <div id="currentImageContainer" class="current-image-container">
                    <h4>Current Image</h4>
                    <img id="currentImagePreview" class="current-image" src="" alt="Current Image">
                    <div id="currentImageActions" style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                        <button onclick="viewCurrentImage()" class="image-action-btn">üëÅÔ∏è View Full Image</button>
                        <button onclick="deleteCurrentImage()" class="image-action-btn delete" style="background: #e74c3c; color: white;">üóëÔ∏è Delete Image</button>
                    </div>
                </div>
                <div class="upload-container" id="uploadContainer">
                    <input type="file" id="imageFileInput" class="file-input" accept="image/*">
                    <button type="button" class="upload-btn" onclick="document.getElementById('imageFileInput').click()">
                        üìÅ Choose Image to Upload
                    </button>
                    <p style="margin: 15px 0; color: #666;">or drag and drop image here</p>
                    <div style="font-size: 13px; color: #7f8c8d; margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 6px;">
                        <strong>Supported formats:</strong> JPG, PNG, GIF, WEBP<br>
                        <strong>Maximum file size:</strong> 5MB<br>
                        <strong>Recommended dimensions:</strong> 800√ó600px or larger
                    </div>
                </div>
                <div id="imagePreviewContainer" style="display: none; text-align: center; margin: 25px 0; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px solid #e0e0e0;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50;">Uploaded Image Preview</h4>
                    <img id="uploadedImagePreview" style="max-width: 100%; max-height: 250px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" src="" alt="Uploaded Image">
                    <div style="margin-top: 15px; color: #27ae60; font-weight: 600;">
                        ‚úÖ Image ready to save
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="closeImageModal()">‚úï Cancel</button>
                    <button type="button" class="save-btn" id="saveImageBtn" onclick="saveImage()" disabled>
                        üíæ Save Image
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Edit Field Modal -->
    <div id="editFieldModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Product Details</h2>
                <button class="close-modal" onclick="closeEditFieldModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="field-info">
                    <h3 id="editFieldName">Edit Product</h3>
                    <p id="editFieldInfo">Update product details and pricing information</p>
                </div>
                <form id="editForm">
                    <div class="form-grid">
                        <div class="form-section">
                            <h4>Basic Information</h4>
    <!-- Product Name Field - ADD THIS -->
    <div class="form-group">
        <label class="required">Product Name</label>
        <input type="text" id="editName" name="name" 
               class="form-control" required 
               placeholder="Enter product name">
        <span class="field-description">The display name of the product</span>
    </div>
    
                            <div class="form-group">
                                <label class="required">Product Status</label>
                                <select id="editStatus" name="status" class="form-control" required>
                                    <option value="">-- Select Status --</option>
                                    <option value="1">Active</option>
                                    <option value="0">Inactive</option>
                                </select>
                                <span class="field-description">Determines product visibility</span>
                            </div>
                            <div class="form-group">
                                <label class="required">Category</label>
                                <select id="editCategory" name="category_id" class="form-control" required>
                                    <option value="">-- Select Category --</option>
                                </select>
                                <span class="field-description">Main product category</span>
                            </div>
                            <div class="form-group">
                                <label>Sub Category (Cat1)</label>
                                <select id="editCat1" name="cat1" class="form-control">
                                    <option value="">-- Select Sub Category --</option>
                                </select>
                                <span class="field-description">Optional sub-category</span>
                            </div>
                            <div class="form-group">
                                <label>Main Description</label>
                                <textarea id="editDescription" name="description" class="form-control" placeholder="Enter main product description"></textarea>
                                <span class="field-description">Main product description</span>
                            </div>
                        </div>
                        <div class="form-section">
                            <h4>Seller & Pricing</h4>
                            <div class="form-group">
                                <label class="required">Seller</label>
                                <select id="editSeller" name="seller_id" class="form-control" required>
                                    <option value="">-- Select Seller --</option>
                                </select>
                                <span class="field-description">Product owner/seller</span>
                            </div>
                            <div class="price-group">
                                <div class="form-group price-field">
                                    <label class="required">Regular Price</label>
                                    <input type="number" id="editPrice" name="retail_simple_price" 
                                           class="form-control" step="0.01" min="0" required 
                                           placeholder="0.00">
                                    <span class="field-description">Base selling price</span>
                                </div>
                                <div class="form-group price-field">
                                    <label>Special Price</label>
                                    <input type="number" id="editSpecialPrice" name="retail_simple_special_price" 
                                           class="form-control" step="0.01" min="0" 
                                           placeholder="0.00">
                                    <span class="field-description">Discounted price (optional)</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Current Status</label>
                                <div id="currentStatusDisplay" class="status-indicator inactive">
                                    Inactive
                                </div>
                                <span class="field-description">Current product status</span>
                            </div>
                            <div class="form-group">
                                <label>Tags (comma separated)</label>
                                <textarea id="editTags" name="tags" class="form-control" 
                                          placeholder="Enter tags separated by commas"></textarea>
                                <span class="field-description">SEO keywords for the product</span>
                            </div>
                            <div class="form-group">
                                <label>Extra Description (Short Description)</label>
                                <textarea id="editExtraDescription" name="extra_description" class="form-control" 
                                          placeholder="Enter a short, catchy description"></textarea>
                                <span class="field-description">Brief description for product listing</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-section">
                        <h4>Additional Information</h4>
                        <div class="form-group">
                            <label>Product SKU</label>
                            <input type="text" id="editSku" name="sku" class="form-control" 
                                   placeholder="Enter product SKU">
                            <span class="field-description">Stock Keeping Unit (optional)</span>
                        </div>
                        <div class="form-group">
                            <label>Quantity in Stock</label>
                            <input type="number" id="editQuantity" name="quantity" class="form-control" 
                                   min="0" step="1" placeholder="0">
                            <span class="field-description">Available stock quantity</span>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" onclick="closeEditFieldModal()">
                            ‚úï Cancel
                        </button>
                        <button type="submit" class="save-btn">
                            üíæ Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
<script>
        // ====================== OPTIMIZED CODE ======================
        
        // Using object pooling and memory management
        const cache = new Map();
        const imageCache = new Map();
        let allProducts = [];
        let filteredProducts = [];
        let searchTimeout = null;
        let debounceTimer = null;
        
        // AI variables
        let currentAIProduct = null;
        let aiResults = {
            enhancedImage: null,
            suggestedCategory: null,
            suggestedCat1: null,
            tags: [],
            description: '',
            extraDescription: ''
        };
        
        // Music variables
let currentMusicProduct = null;
let generatedLyrics = '';
let generatedStyle = '';
let uploadedMusicUrl = null;
let uploadedMusicFile = null;
let currentMode = null;
        
        // Image upload variables
        let currentProductId = null;
        let currentImageField = null;
        let currentImageUrl = null;
        let uploadedImageUrl = null;
        let uploadedFile = null;
        
        // Edit field variables
        let currentEditProductId = null;
        let currentEditField = null;
        
        // Filter counts
        let filterCounts = {
            status: { all: 0, '1': 0, '0': 0 },
            category: {},
            cat1: {},
            seller: {}
        };
        
        // Store categories and sellers
        let categoriesList = [];
        let sellersList = [];
        // Prompts storage
const defaultPrompts = {
    lyrics: `Write a 30-second song inspired by the following product description.

Style: Warm, modern, cozy, aesthetic, lightly funny
Mood: Home comfort, everyday love, handcrafted beauty, Indian warmth
Genre: Indie pop / soft lo-fi / acoustic chill (Indian indie vibe)
Tempo: Medium

Requirements:
Convert product features into emotional, poetic lyrics
Reflect Indian sensibilities (homely vibes, small joys, cozy chaos, "ghar wali feeling")
Highlight handcrafted / artisan feel naturally
Keep the tone relatable, warm, slightly playful
Avoid sounding like an advertisement
Suitable for a 30-second Suno clip (8‚Äì10 short lines)
Include a catchy hook that evokes comfort and home

Product Information:
Name: {productName}
Description: {description}
Category: {category}
Cat1: {cat1}
Price: {price}
Special Price: {specialPrice}

Generate ONLY the lyrics, no explanations or additional text. Do NOT use any section labels like Verse, Chorus, Hook, Bridge, Outro, etc. Present the lyrics as a continuous flow of lines only.`,

    style: `Based on the following product information, suggest a detailed music style description for a 30-second song.

Consider:
1. Music genre and sub-genre
2. Mood and emotional tone
3. Tempo and rhythm
4. Instrumentation
5. Vocal style (if any)
6. Production style
7. Cultural influences
8. Similar artists or references

Requirements:
- Be specific and detailed
- Suggest a style that matches the product's theme and category
- Include practical suggestions for Suno.ai
- Keep it concise but comprehensive
- Focus on Indian indie/folk/pop influences if appropriate

Product Information:
Name: {productName}
Description: {description}
Category: {category}
Cat1: {cat1}
Price: {price}
Special Price: {specialPrice}

Generate ONLY the style description, no explanations or additional text.`
};

let customPrompts = JSON.parse(JSON.stringify(defaultPrompts));
        // Performance optimizations
        const ProductManager = {
            products: [],
            
            // Efficient product filtering with memoization
            filterProducts: (searchTerm, filters) => {
                const cacheKey = JSON.stringify({ searchTerm, filters });
                if (cache.has(cacheKey)) {
                    return cache.get(cacheKey);
                }
                
                const filtered = allProducts.filter(product => {
                    // Search filter
                    if (searchTerm) {
                        const searchStr = `${product.name} ${product.id} ${product.sku || ''} ${product.description || ''}`.toLowerCase();
                        if (!searchStr.includes(searchTerm.toLowerCase())) {
                            return false;
                        }
                    }
                    
                    // Apply all filters
                    for (const [key, value] of Object.entries(filters)) {
                        if (value !== 'all' && value !== undefined && String(product[key]) !== value) {
                            return false;
                        }
                    }
                    
                    return true;
                });
                
                cache.set(cacheKey, filtered);
                return filtered;
            },
            
            // Clear cache when needed
            clearCache: () => {
                cache.clear();
                imageCache.clear();
            },
            
            // Efficient product update
            updateProduct: (productId, updates) => {
                const index = allProducts.findIndex(p => p.id == productId);
                if (index !== -1) {
                    allProducts[index] = { ...allProducts[index], ...updates };
                    // Clear relevant cache
                    cache.clear();
                }
            }
        };
        
        // Optimized image loader with lazy loading
        class OptimizedImageLoader {
            constructor() {
                this.observer = null;
                this.initIntersectionObserver();
            }
            
            initIntersectionObserver() {
                if ('IntersectionObserver' in window) {
                    this.observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const img = entry.target;
                                this.loadImage(img);
                                this.observer.unobserve(img);
                            }
                        });
                    }, {
                        rootMargin: '50px 0px',
                        threshold: 0.1
                    });
                }
            }
            
            loadImage(imgElement) {
                const src = imgElement.getAttribute('data-src');
                if (!src || src.trim() === '') {
                    this.setPlaceholder(imgElement);
                    return;
                }
                
                // Check cache first
                if (imageCache.has(src)) {
                    const cached = imageCache.get(src);
                    if (cached.loaded) {
                        imgElement.src = src;
                        imgElement.classList.add('loaded');
                    }
                    return;
                }
                
                // Load new image
                const img = new Image();
                img.onload = () => {
                    imgElement.src = src;
                    imgElement.classList.add('loaded');
                    imageCache.set(src, { loaded: true });
                };
                
                img.onerror = () => {
                    this.setPlaceholder(imgElement);
                    imageCache.set(src, { loaded: true });
                };
                
                img.src = src;
            }
            
            setPlaceholder(imgElement) {
                imgElement.src = 'https://via.placeholder.com/300x200?text=No+Image';
                imgElement.classList.add('loaded');
            }
            
            observeImage(imgElement) {
                if (this.observer) {
                    this.observer.observe(imgElement);
                } else {
                    this.loadImage(imgElement);
                }
            }
        }
        
        const imageLoader = new OptimizedImageLoader();
        
        // Helper functions
        function getFullImageUrl(url) {
            if (!url || url.trim() === '') return '';
            if (url.startsWith('http://') || url.startsWith('https://')) return url;
            return 'https://zulushop.in/' + url;
        }
        
        function debounce(func, wait) {
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(debounceTimer);
                    func(...args);
                };
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(later, wait);
            };
        }
        
        function showMessage(text, type = 'success') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.style.background = type === 'success' ? '#d4edda' : 
                                         type === 'error' ? '#f8d7da' : '#d1ecf1';
            messageDiv.style.color = type === 'success' ? '#155724' : 
                                    type === 'error' ? '#721c24' : '#0c5460';
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            
            // Debounced search
            document.getElementById('searchInput').addEventListener('input', debounce(() => {
                filterProducts();
            }, 300));
            
            // Filter events with debouncing
            ['statusFilter', 'categoryFilter', 'cat1Filter', 'sellerFilter'].forEach(id => {
                document.getElementById(id).addEventListener('change', debounce(() => {
                    updateFilterOptions();
                    filterProducts();
                }, 200));
            });
            
            setupFormValidation();
            loadSavedPrompts();

        });
// Add to existing validation functions
function validateName(input) {
    const value = input.value.trim();
    if (!value || value.length < 2) {
        input.classList.add('invalid');
        input.classList.remove('valid');
        return false;
    } else {
        input.classList.add('valid');
        input.classList.remove('invalid');
        return true;
    }
}
        // Form validation
        function setupFormValidation() {
            const form = document.getElementById('editForm');
            const priceInput = document.getElementById('editPrice');
            const specialPriceInput = document.getElementById('editSpecialPrice');
            const nameInput = document.getElementById('editName'); // ADD THIS

            priceInput.addEventListener('input', function() {
                validatePrice(this);
            });
            
            specialPriceInput.addEventListener('input', function() {
                validateSpecialPrice(this);
            });
            
            nameInput.addEventListener('input', function() {
                validateName(this);
            });
    
            form.addEventListener('submit', function(e) {
                if (!validateForm()) {
                    e.preventDefault();
                    showMessage('‚ùå Please fix the errors in the form', 'error');
                }
            });
        }
        
        function validatePrice(input) {
            const value = parseFloat(input.value);
            if (value < 0) {
                input.classList.add('invalid');
                input.classList.remove('valid');
                return false;
            } else if (value > 0) {
                input.classList.add('valid');
                input.classList.remove('invalid');
                return true;
            }
            return true;
        }
        
        function validateSpecialPrice(input) {
            const price = parseFloat(document.getElementById('editPrice').value);
            const specialPrice = parseFloat(input.value);
            
            if (specialPrice < 0) {
                input.classList.add('invalid');
                input.classList.remove('valid');
                return false;
            } else if (specialPrice > 0 && specialPrice >= price) {
                input.classList.add('invalid');
                input.classList.remove('valid');
                showMessage('Special price must be less than regular price', 'error');
                return false;
            } else if (specialPrice > 0) {
                input.classList.add('valid');
                input.classList.remove('invalid');
                return true;
            }
            return true;
        }
        
        function validateForm() {
            let isValid = true;
            const requiredFields = ['editName', 'editStatus', 'editCategory', 'editSeller', 'editPrice'];
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('invalid');
                    isValid = false;
                } else {
                    field.classList.remove('invalid');
                }
            });
            
            return isValid;
        }
        
        // Load products with optimization
        async function loadProducts() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('productsContainer').innerHTML = '';
            
            try {
                const response = await fetch('/api/productsenhanced');
                const data = await response.json();
                
                if (data?.success && Array.isArray(data.data)) {
                    // Process products in chunks for better performance
                    const chunkSize = 50;
                    allProducts = [];
                    
                    for (let i = 0; i < data.data.length; i += chunkSize) {
                        const chunk = data.data.slice(i, i + chunkSize);
                        const processedChunk = chunk.map((product, index) => {
                            let mainImage = null;
                            const possibleImageFields = ['image', 'IMAGE', 'other_images'];
                            
                            for (const field of possibleImageFields) {
                                if (product[field]) {
                                    if (field === 'other_images') {
                                        try {
                                            const otherImages = JSON.parse(product[field]);
                                            if (Array.isArray(otherImages) && otherImages.length > 0) {
                                                mainImage = otherImages[0];
                                            }
                                        } catch {
                                            const images = String(product[field]).split(',').filter(img => img.trim());
                                            if (images.length > 0) {
                                                mainImage = images[0].trim();
                                            }
                                        }
                                    } else {
                                        mainImage = product[field];
                                    }
                                    if (mainImage) break;
                                }
                            }
                            
                            return {
                                ...product,
                                id: product.id || index + 1,
                                name: product.name || product.title || 'Unnamed Product',
                                image: mainImage ? getFullImageUrl(mainImage) : null,
                                hasImage: !!mainImage,
                                // Ensure we have formatted prices
                                formatted_price: product.formatted_price || (product.retail_simple_price ? `‚Çπ${parseFloat(product.retail_simple_price).toFixed(2)}` : '‚Çπ0.00'),
                                formatted_special_price: product.formatted_special_price || (product.retail_simple_special_price ? `‚Çπ${parseFloat(product.retail_simple_special_price).toFixed(2)}` : '‚Çπ0.00')
                            };
                        });
                        
                        allProducts.push(...processedChunk);
                    }
                    
                    categoriesList = data.categories || [];
                    sellersList = data.sellers || [];
                    
                    calculateFilterCounts();
                    populateFilters();
                    
                    showMessage(`‚úÖ Loaded ${allProducts.length} products successfully`, 'success');
                    filterProducts();
                } else {
                    throw new Error(data?.error || 'Invalid data format');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Error loading products: ' + error.message;
                showMessage('‚ùå Failed to load products', 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // Calculate filter counts
        function calculateFilterCounts() {
            filterCounts = {
                status: { all: allProducts.length, '1': 0, '0': 0 },
                category: {},
                cat1: {},
                seller: {}
            };
            
            // Use for loop for better performance with large datasets
            for (let i = 0; i < allProducts.length; i++) {
                const product = allProducts[i];
                
                // Status counts
                if (product.status == '1' || product.status == 1) {
                    filterCounts.status['1']++;
                } else {
                    filterCounts.status['0']++;
                }
                
                // Category counts
                if (product.category_id) {
                    const catId = String(product.category_id);
                    filterCounts.category[catId] = (filterCounts.category[catId] || 0) + 1;
                }
                
                // Cat1 counts
                if (product.cat1) {
                    const cat1Id = String(product.cat1);
                    filterCounts.cat1[cat1Id] = (filterCounts.cat1[cat1Id] || 0) + 1;
                }
                
                // Seller counts
                if (product.seller_id) {
                    const sellerId = String(product.seller_id);
                    filterCounts.seller[sellerId] = (filterCounts.seller[sellerId] || 0) + 1;
                }
            }
            
            updateFilterCountBadges();
        }
        
        // Update filter count badges
        function updateFilterCountBadges() {
            const statusFilter = document.getElementById('statusFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            const cat1Filter = document.getElementById('cat1Filter');
            const sellerFilter = document.getElementById('sellerFilter');
            
            const selectedStatus = statusFilter.value;
            const selectedCategory = categoryFilter.value;
            const selectedCat1 = cat1Filter.value;
            const selectedSeller = sellerFilter.value;
            
            let filtered = [...allProducts];
            
            if (selectedStatus !== 'all') {
                filtered = filtered.filter(p => String(p.status) === selectedStatus);
            }
            if (selectedCategory !== 'all') {
                filtered = filtered.filter(p => String(p.category_id) === selectedCategory);
            }
            if (selectedCat1 !== 'all') {
                filtered = filtered.filter(p => String(p.cat1) === selectedCat1);
            }
            if (selectedSeller !== 'all') {
                filtered = filtered.filter(p => String(p.seller_id) === selectedSeller);
            }
            
            document.getElementById('statusCount').textContent = filtered.length;
            
            const uniqueCategories = new Set();
            const uniqueCat1 = new Set();
            const uniqueSellers = new Set();
            
            for (let i = 0; i < filtered.length; i++) {
                const p = filtered[i];
                if (p.category_id) uniqueCategories.add(p.category_id);
                if (p.cat1) uniqueCat1.add(p.cat1);
                if (p.seller_id) uniqueSellers.add(p.seller_id);
            }
            
            document.getElementById('categoryCount').textContent = uniqueCategories.size;
            document.getElementById('cat1Count').textContent = uniqueCat1.size;
            document.getElementById('sellerCount').textContent = uniqueSellers.size;
        }
        
        // Populate filter dropdowns
        function populateFilters() {
            const categoryFilter = document.getElementById('categoryFilter');
            const cat1Filter = document.getElementById('cat1Filter');
            const sellerFilter = document.getElementById('sellerFilter');
            
            while (categoryFilter.options.length > 1) categoryFilter.remove(1);
            while (cat1Filter.options.length > 1) cat1Filter.remove(1);
            while (sellerFilter.options.length > 1) sellerFilter.remove(1);
            
            const categories = [...new Set(allProducts.map(p => p.category_id).filter(id => id))];
            const cat1s = [...new Set(allProducts.map(p => p.cat1).filter(id => id))];
            const sellers = [...new Set(allProducts.map(p => p.seller_id).filter(id => id))];
            
            categories.sort((a, b) => filterCounts.category[b] - filterCounts.category[a]);
            cat1s.sort((a, b) => filterCounts.cat1[b] - filterCounts.cat1[a]);
            sellers.sort((a, b) => filterCounts.seller[b] - filterCounts.seller[a]);
            
            categories.forEach(id => {
                const product = allProducts.find(p => p.category_id == id);
                const name = product?.category_name || `Category ${id}`;
                const count = filterCounts.category[id] || 0;
                const option = new Option(`${name} (${count} products)`, id);
                categoryFilter.add(option);
            });
            
            cat1s.forEach(id => {
                const product = allProducts.find(p => p.cat1 == id);
                const name = product?.cat1_name || `Cat1 ${id}`;
                const count = filterCounts.cat1[id] || 0;
                const option = new Option(`${name} (${count} products)`, id);
                cat1Filter.add(option);
            });
            
            sellers.forEach(id => {
                const product = allProducts.find(p => p.seller_id == id);
                const name = product?.seller_name || `Seller ${id}`;
                const count = filterCounts.seller[id] || 0;
                const option = new Option(`${name} (${count} products)`, id);
                sellerFilter.add(option);
            });
        }
        
        // Update filter options
        function updateFilterOptions() {
            const status = document.getElementById('statusFilter').value;
            const category = document.getElementById('categoryFilter').value;
            const cat1 = document.getElementById('cat1Filter').value;
            const seller = document.getElementById('sellerFilter').value;
            
            let filtered = [...allProducts];
            
            if (status !== 'all') filtered = filtered.filter(p => String(p.status) === status);
            if (category !== 'all') filtered = filtered.filter(p => String(p.category_id) === category);
            if (cat1 !== 'all') filtered = filtered.filter(p => String(p.cat1) === cat1);
            if (seller !== 'all') filtered = filtered.filter(p => String(p.seller_id) === seller);
            
            const availableCategories = [...new Set(filtered.map(p => p.category_id).filter(id => id))];
            const availableCat1s = [...new Set(filtered.map(p => p.cat1).filter(id => id))];
            const availableSellers = [...new Set(filtered.map(p => p.seller_id).filter(id => id))];
            
            const categoryCounts = {};
            const cat1Counts = {};
            const sellerCounts = {};
            
            filtered.forEach(p => {
                if (p.category_id) {
                    const id = String(p.category_id);
                    categoryCounts[id] = (categoryCounts[id] || 0) + 1;
                }
                if (p.cat1) {
                    const id = String(p.cat1);
                    cat1Counts[id] = (cat1Counts[id] || 0) + 1;
                }
                if (p.seller_id) {
                    const id = String(p.seller_id);
                    sellerCounts[id] = (sellerCounts[id] || 0) + 1;
                }
            });
            
            updateFilterDropdownWithCounts('categoryFilter', availableCategories, 'category_name', category, categoryCounts);
            updateFilterDropdownWithCounts('cat1Filter', availableCat1s, 'cat1_name', cat1, cat1Counts);
            updateFilterDropdownWithCounts('sellerFilter', availableSellers, 'seller_name', seller, sellerCounts);
            
            updateFilterCountBadges();
        }
        
        function updateFilterDropdownWithCounts(filterId, availableIds, nameField, currentSelected, counts) {
            const dropdown = document.getElementById(filterId);
            const currentValue = dropdown.value;
            
            while (dropdown.options.length > 1) dropdown.remove(1);
            
            availableIds.sort((a, b) => (counts[b] || 0) - (counts[a] || 0));
            
            availableIds.forEach(id => {
                const product = allProducts.find(p => {
                    if (nameField === 'category_name') return p.category_id == id;
                    if (nameField === 'cat1_name') return p.cat1 == id;
                    if (nameField === 'seller_name') return p.seller_id == id;
                    return false;
                });
                
                const name = product?.[nameField] || `${nameField.split('_')[0]} ${id}`;
                const count = counts[id] || 0;
                const option = new Option(`${name} (${count} products)`, id);
                dropdown.add(option);
            });
            
            if (currentSelected !== 'all' && availableIds.includes(parseInt(currentSelected))) {
                dropdown.value = currentSelected;
            } else {
                dropdown.value = 'all';
            }
        }
        
        // Filter products - FIXED VERSION
        function filterProducts() {
            const searchTerm = document.getElementById('searchInput').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const cat1Filter = document.getElementById('cat1Filter').value;
            const sellerFilter = document.getElementById('sellerFilter').value;
            
            // Build filters object - pass 'all' for no filter
            const filters = {
                status: statusFilter,
                category_id: categoryFilter,
                cat1: cat1Filter,
                seller_id: sellerFilter
            };
            
            filteredProducts = ProductManager.filterProducts(searchTerm, filters);
            
            displayProducts();
        }
        
        // SIMPLIFIED VERSION WITHOUT ProductManager if above doesn't work
        function filterProductsSimple() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const cat1Filter = document.getElementById('cat1Filter').value;
            const sellerFilter = document.getElementById('sellerFilter').value;
            
            filteredProducts = allProducts.filter(product => {
                // Search filter
                if (searchTerm) {
                    const searchable = [
                        product.name,
                        product.id.toString(),
                        product.sku || '',
                        product.description || '',
                        product.category_name || '',
                        product.seller_name || ''
                    ].join(' ').toLowerCase();
                    
                    if (!searchable.includes(searchTerm)) {
                        return false;
                    }
                }
                
                // Status filter
                if (statusFilter !== 'all') {
                    if (String(product.status) !== statusFilter) {
                        return false;
                    }
                }
                
                // Category filter
                if (categoryFilter !== 'all') {
                    if (String(product.category_id) !== categoryFilter) {
                        return false;
                    }
                }
                
                // Cat1 filter
                if (cat1Filter !== 'all') {
                    if (String(product.cat1) !== cat1Filter) {
                        return false;
                    }
                }
                
                // Seller filter
                if (sellerFilter !== 'all') {
                    if (String(product.seller_id) !== sellerFilter) {
                        return false;
                    }
                }
                
                return true;
            });
            
            displayProducts();
        }
        
        // Display products with optimization
        function displayProducts() {
            const container = document.getElementById('productsContainer');
            
            if (filteredProducts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 24px; margin-bottom: 10px;">üîç</div>
                        <div style="font-size: 20px; font-weight: 600; margin-bottom: 10px; color: #2c3e50;">No Products Found</div>
                        <div style="color: #7f8c8d; margin-bottom: 20px;">Try adjusting your search or filters</div>
                        <button onclick="resetFilters()" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            Reset All Filters
                        </button>
                    </div>
                `;
                return;
            }
            
            // Use document fragment for better performance
            const fragment = document.createDocumentFragment();
            
            for (let i = 0; i < filteredProducts.length; i++) {
                const product = filteredProducts[i];
                const isActive = product.status == '1' || product.status == 1;
                const hasSpecialPrice = product.retail_simple_special_price && 
                                       parseFloat(product.retail_simple_special_price) > 0 &&
                                       product.retail_simple_price &&
                                       parseFloat(product.retail_simple_special_price) < parseFloat(product.retail_simple_price);
                
                const productTags = product.tags ? product.tags.split(',').slice(0, 3) : [];
                const productExtraDesc = product.extra_description || '';
                
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div class="card-image">
                        <img data-src="${product.image || ''}" alt="${product.name}" 
                             onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'; this.classList.add('loaded')">
                        <div class="image-actions">
                            <button class="image-action-btn" onclick="openImageModal(${product.id}, 'image', '${encodeURIComponent(product.image || '')}'); event.stopPropagation();">
                                ‚úèÔ∏è Edit Image
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-title">${product.name}</div>
                        <div class="card-id">ID: ${product.id}${product.sku ? ` | SKU: ${product.sku}` : ''}</div>
                        <div class="card-prices">
                            ${hasSpecialPrice ? `
                                <span class="original-price">${product.formatted_price || '‚Çπ0.00'}</span>
                                <span class="special-price">${product.formatted_special_price || '‚Çπ0.00'}</span>
                            ` : product.retail_simple_price ? `
                                <span class="normal-price">${product.formatted_price || '‚Çπ' + parseFloat(product.retail_simple_price).toFixed(2)}</span>
                            ` : '<span style="color: #95a5a6;">No price set</span>'}
                        </div>
                        <div class="card-info">
                            ${product.category_name ? `
                                <span class="info-tag category" 
                                      onclick="setFilter('categoryFilter', '${product.category_id}')"
                                      title="Click to filter by this category">
                                    üìÇ ${product.category_name}
                                </span>
                            ` : ''}
                            ${product.cat1_name ? `
                                <span class="info-tag category" 
                                      onclick="setFilter('cat1Filter', '${product.cat1}')"
                                      title="Click to filter by this cat1">
                                    üìÅ ${product.cat1_name}
                                </span>
                            ` : ''}
                            ${product.seller_name ? `
                                <span class="info-tag seller" 
                                      onclick="setFilter('sellerFilter', '${product.seller_id}')"
                                      title="Click to filter by this seller">
                                    üë§ ${product.seller_name}
                                </span>
                            ` : ''}
                            <span class="info-tag status ${isActive ? 'active' : 'inactive'}"
                                  onclick="setFilter('statusFilter', '${isActive ? '1' : '0'}')"
                                  title="Click to filter by this status">
                                ${isActive ? '‚úÖ Active' : '‚ùå Inactive'}
                            </span>
                            ${productTags.length > 0 ? `
                                <span class="info-tag" style="background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%); color: #d63031;">
                                    üè∑Ô∏è ${productTags.join(', ')}
                                </span>
                            ` : ''}
                            ${productExtraDesc ? `
                                <span class="info-tag" style="background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%); color: white;" 
                                      title="${productExtraDesc}">
                                    ‚ú® Extra
                                </span>
                            ` : ''}
                            <span class="info-tag edit" 
                                  onclick="openEditOptionsModal(${product.id})"
                                  title="Edit all fields">
                                ‚úèÔ∏è Edit Product
                            </span>
                            <span class="info-tag music" 
                                  onclick="generateMusic(${product.id})"
                                  title="Generate song lyrics and music">
                                üéµ Generate Music
                            </span>
                            <span class="info-tag ai" 
                                  onclick="runAITasks(${product.id})"
                                  title="Run AI Tasks">
                                ü§ñ AI Tasks
                            </span>
                        </div>
                    </div>
                `;
                
                fragment.appendChild(card);
            }
            
            container.innerHTML = '';
            container.appendChild(fragment);
            
            // Lazy load images
            setTimeout(() => {
                const images = container.querySelectorAll('.card-image img');
                images.forEach(img => imageLoader.observeImage(img));
            }, 10);
        }
        
        // TEST FUNCTION - Add this to debug
        function debugFilter() {
            console.log('All products:', allProducts.length);
            console.log('Filtered products:', filteredProducts.length);
            console.log('Search input:', document.getElementById('searchInput').value);
            console.log('Filters:', {
                status: document.getElementById('statusFilter').value,
                category: document.getElementById('categoryFilter').value,
                cat1: document.getElementById('cat1Filter').value,
                seller: document.getElementById('sellerFilter').value
            });
        }
        
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('cat1Filter').value = 'all';
            document.getElementById('sellerFilter').value = 'all';
            updateFilterOptions();
            filterProducts();
        }
        
        function setFilter(filterId, value) {
            const filter = document.getElementById(filterId);
            filter.value = value;
            updateFilterOptions();
            filterProducts();
        }
        
        // Enhanced Edit Form Modal
        function openEditOptionsModal(productId) {
            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                showMessage('‚ùå Product not found', 'error');
                return;
            }
            
            currentEditProductId = productId;
            
            document.getElementById('editFieldName').textContent = `Edit: ${product.name}`;
            document.getElementById('editFieldInfo').textContent = `Product ID: ${productId}`;
            document.getElementById('editName').value = product.name || '';

            const isActive = product.status == '1' || product.status == 1;
            const statusDisplay = document.getElementById('currentStatusDisplay');
            statusDisplay.className = `status-indicator ${isActive ? 'active' : 'inactive'}`;
            statusDisplay.textContent = isActive ? 'Active' : 'Inactive';
            
            const categorySelect = document.getElementById('editCategory');
            categorySelect.innerHTML = '<option value="">-- Select Category --</option>';
            categoriesList.forEach(cat => {
                const selected = cat.id == product.category_id ? 'selected' : '';
                categorySelect.innerHTML += `<option value="${cat.id}" ${selected}>${cat.name} (ID: ${cat.id})</option>`;
            });
            
            const cat1Select = document.getElementById('editCat1');
            cat1Select.innerHTML = '<option value="">-- Select Sub Category --</option>';
            categoriesList.forEach(cat => {
                const selected = cat.id == product.cat1 ? 'selected' : '';
                cat1Select.innerHTML += `<option value="${cat.id}" ${selected}>${cat.name} (ID: ${cat.id})</option>`;
            });
            
            const sellerSelect = document.getElementById('editSeller');
            sellerSelect.innerHTML = '<option value="">-- Select Seller --</option>';
            sellersList.forEach(seller => {
                const selected = seller.user_id == product.seller_id ? 'selected' : '';
                sellerSelect.innerHTML += `<option value="${seller.user_id}" ${selected}>${seller.store_name} (ID: ${seller.user_id})</option>`;
            });
            
            document.getElementById('editStatus').value = product.status || '';
            document.getElementById('editPrice').value = product.retail_simple_price || '';
            document.getElementById('editSpecialPrice').value = product.retail_simple_special_price || '';
            document.getElementById('editSku').value = product.sku || '';
            document.getElementById('editQuantity').value = product.quantity || '';
            document.getElementById('editTags').value = product.tags || '';
            document.getElementById('editExtraDescription').value = product.extra_description || '';
            document.getElementById('editDescription').value = product.description || '';
            
            const formControls = document.querySelectorAll('.form-control');
            formControls.forEach(control => {
                control.classList.remove('invalid', 'valid');
            });
            
            const modal = document.getElementById('editFieldModal');
            modal.style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('editStatus').focus();
            }, 100);
        }
        
        function closeEditFieldModal() {
            const modal = document.getElementById('editFieldModal');
            modal.style.display = 'none';
            currentEditProductId = null;
            
            const formControls = document.querySelectorAll('.form-control');
            formControls.forEach(control => {
                control.classList.remove('invalid', 'valid');
            });
        }
        
        // Handle field edit form submission
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validateForm()) return;
            
            const formData = {
                name: document.getElementById('editName').value,
                status: document.getElementById('editStatus').value,
                category_id: document.getElementById('editCategory').value,
                cat1: document.getElementById('editCat1').value || null,
                seller_id: document.getElementById('editSeller').value,
                retail_simple_price: document.getElementById('editPrice').value,
                retail_simple_special_price: document.getElementById('editSpecialPrice').value || null,
                sku: document.getElementById('editSku').value || null,
                quantity: document.getElementById('editQuantity').value || null,
                tags: document.getElementById('editTags').value || null,
                extra_description: document.getElementById('editExtraDescription').value || null,
                description: document.getElementById('editDescription').value || null
            };
            
            const updateData = {};
            Object.keys(formData).forEach(key => {
                if (formData[key] !== '' && formData[key] !== undefined && formData[key] !== null) {
                    updateData[key] = formData[key];
                }
            });
            
            if (Object.keys(updateData).length === 0) {
                showMessage('‚ÑπÔ∏è No changes to save', 'info');
                return;
            }
            
            try {
                showMessage('üîÑ Saving changes...', 'info');
                
                const saveBtn = document.querySelector('#editForm .save-btn');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '‚è≥ Saving...';
                saveBtn.disabled = true;
                
                const response = await fetch(`/api/products/${currentEditProductId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                
                if (result.success) {
                    document.querySelector('.modal-content').classList.add('form-success');
                    showMessage('‚úÖ Product updated successfully!', 'success');
                    
                    const productIndex = allProducts.findIndex(p => p.id == currentEditProductId);
                    if (productIndex !== -1) {
                        Object.keys(updateData).forEach(key => {
                            allProducts[productIndex][key] = updateData[key];
                        });
                        if (updateData.name) {
                            allProducts[productIndex].name = updateData.name;
                        }

                        if (updateData.category_id) {
                            const category = categoriesList.find(cat => cat.id == updateData.category_id);
                            allProducts[productIndex].category_name = category?.name || '';
                        }
                        
                        if (updateData.cat1) {
                            const category = categoriesList.find(cat => cat.id == updateData.cat1);
                            allProducts[productIndex].cat1_name = category?.name || '';
                        }
                        
                        if (updateData.seller_id) {
                            const seller = sellersList.find(s => s.user_id == updateData.seller_id);
                            allProducts[productIndex].seller_name = seller?.store_name || '';
                        }
                        
                        if (updateData.retail_simple_price) {
                            allProducts[productIndex].formatted_price = `‚Çπ${parseFloat(updateData.retail_simple_price).toFixed(2)}`;
                        }
                        
                        if (updateData.retail_simple_special_price) {
                            allProducts[productIndex].formatted_special_price = `‚Çπ${parseFloat(updateData.retail_simple_special_price).toFixed(2)}`;
                        }
                    }
                    
                    calculateFilterCounts();
                    updateFilterOptions();
                    filterProducts();
                    
                    setTimeout(() => {
                        closeEditFieldModal();
                        setTimeout(() => {
                            document.querySelector('.modal-content').classList.remove('form-success');
                        }, 300);
                    }, 1500);
                } else {
                    showMessage(`‚ùå Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`‚ùå Network error: ${error.message}`, 'error');
                const saveBtn = document.querySelector('#editForm .save-btn');
                saveBtn.innerHTML = 'üíæ Save Changes';
                saveBtn.disabled = false;
            }
        });
        
        // Image Modal Functions
        function openImageModal(productId, field, imageUrl) {
            currentProductId = productId;
            currentImageField = field;
            currentImageUrl = decodeURIComponent(imageUrl || '');
            
            document.getElementById('imageFieldName').textContent = 'Product Image';
            document.getElementById('imageFieldInfo').textContent = `Product ID: ${productId}`;
            
            const currentImageContainer = document.getElementById('currentImageContainer');
            const currentImagePreview = document.getElementById('currentImagePreview');
            
            if (currentImageUrl && currentImageUrl.trim() !== '') {
                currentImagePreview.src = currentImageUrl;
                currentImagePreview.onerror = function() {
                    this.src = 'https://via.placeholder.com/200x150?text=Image+Not+Found';
                };
                currentImageContainer.style.display = 'block';
            } else {
                currentImageContainer.style.display = 'none';
            }
            
            resetUploadSection();
            setupDragAndDrop();
            
            document.getElementById('imageUploadModal').style.display = 'block';
        }
        
        function closeImageModal() {
            document.getElementById('imageUploadModal').style.display = 'none';
            currentProductId = null;
            currentImageField = null;
            currentImageUrl = null;
            uploadedImageUrl = null;
            uploadedFile = null;
        }
        
        function viewCurrentImage() {
            if (currentImageUrl) {
                window.open(currentImageUrl, '_blank');
            }
        }
        
        function deleteCurrentImage() {
            if (confirm('Are you sure you want to delete this image?')) {
                saveImageToServer('');
            }
        }
        
        function setupDragAndDrop() {
            const uploadContainer = document.getElementById('uploadContainer');
            const fileInput = document.getElementById('imageFileInput');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadContainer.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadContainer.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadContainer.addEventListener(eventName, unhighlight, false);
            });
            
            uploadContainer.addEventListener('drop', handleDrop, false);
            fileInput.addEventListener('change', handleFileSelect, false);
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight() {
                uploadContainer.classList.add('dragover');
            }
            
            function unhighlight() {
                uploadContainer.classList.remove('dragover');
            }
            
            function handleDrop(e) {
                const files = e.dataTransfer.files;
                handleFiles(files);
            }
            
            function handleFileSelect(e) {
                const files = e.target.files;
                handleFiles(files);
            }
        }
        
        function handleFiles(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            
            if (!validTypes.includes(file.type)) {
                showMessage('‚ùå Please select a valid image file (JPG, PNG, GIF, WEBP)', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showMessage('‚ùå Image size must be less than 5MB', 'error');
                return;
            }
            
            uploadedFile = file;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('uploadedImagePreview');
                preview.src = e.target.result;
                document.getElementById('imagePreviewContainer').style.display = 'block';
                document.getElementById('saveImageBtn').disabled = false;
            };
            reader.readAsDataURL(file);
            
            uploadImage(file);
        }
        
        async function uploadImage(file) {
            try {
                const formData = new FormData();
                formData.append('image', file);
                
                const response = await fetch('https://api.zulushop.in/api/v1/user/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const responseText = await response.text();
                
                if (response.ok) {
                    let jsonRes;
                    try {
                        jsonRes = JSON.parse(responseText);
                    } catch {
                        throw new Error('Invalid response from server');
                    }
                    
                    let url = jsonRes.url || jsonRes.image_url || 
                             (jsonRes.data ? (typeof jsonRes.data === 'string' ? jsonRes.data : 
                             jsonRes.data.url || jsonRes.data.image_url) : null);
                    
                    if (url) {
                        uploadedImageUrl = url;
                        showMessage('‚úÖ Image uploaded successfully!', 'success');
                        return url;
                    } else {
                        throw new Error('No image URL in response');
                    }
                } else {
                    throw new Error(`Upload failed: ${response.status}`);
                }
            } catch (error) {
                showMessage(`‚ùå Upload failed: ${error.message}`, 'error');
                document.getElementById('saveImageBtn').disabled = true;
                throw error;
            }
        }
        
        function resetUploadSection() {
            uploadedImageUrl = null;
            uploadedFile = null;
            document.getElementById('imagePreviewContainer').style.display = 'none';
            document.getElementById('saveImageBtn').disabled = true;
            document.getElementById('imageFileInput').value = '';
        }
        
        function saveImage() {
            if (uploadedImageUrl) {
                saveImageToServer(uploadedImageUrl);
            } else {
                showMessage('‚ùå Please upload an image first', 'error');
            }
        }
        
        async function saveImageToServer(imageUrl) {
            try {
                showMessage('üîÑ Saving image...', 'info');
                
                const updateData = {};
                updateData[currentImageField] = imageUrl;
                
                const response = await fetch(`/api/products/${currentProductId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ Image saved successfully!', 'success');
                    
                    const productIndex = allProducts.findIndex(p => p.id == currentProductId);
                    if (productIndex !== -1) {
                        allProducts[productIndex].image = imageUrl;
                        allProducts[productIndex].hasImage = !!imageUrl;
                    }
                    
                    filterProducts();
                    
                    setTimeout(() => {
                        closeImageModal();
                    }, 1000);
                } else {
                    showMessage(`‚ùå Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`‚ùå Network error: ${error.message}`, 'error');
            }
        }
        
        function viewImage(url) {
            if (url) {
                window.open(url, '_blank');
            }
        }
        

// Load saved prompts
function loadSavedPrompts() {
    const savedPrompts = localStorage.getItem('productPrompts');
    if (savedPrompts) {
        try {
            const parsed = JSON.parse(savedPrompts);
            if (parsed.lyrics) customPrompts.lyrics = parsed.lyrics;
            if (parsed.style) customPrompts.style = parsed.style;
        } catch (e) {
            console.error('Error loading saved prompts:', e);
        }
    }
}

// Save prompts
function savePromptsToStorage() {
    localStorage.setItem('productPrompts', JSON.stringify(customPrompts));
}

        // Music Functions
        function generateMusic(productId) {
            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                showMessage('‚ùå Product not found', 'error');
                return;
            }
            currentMusicProduct = product;
            openMusicModal();
        }
        
// Load saved prompts
function loadSavedPrompts() {
    const savedPrompts = localStorage.getItem('productPrompts');
    if (savedPrompts) {
        try {
            const parsed = JSON.parse(savedPrompts);
            if (parsed.lyrics) customPrompts.lyrics = parsed.lyrics;
            if (parsed.style) customPrompts.style = parsed.style;
        } catch (e) {
            console.error('Error loading saved prompts:', e);
        }
    }
}

// Save prompts
function savePromptsToStorage() {
    localStorage.setItem('productPrompts', JSON.stringify(customPrompts));
}

// Generate Music Button Click - Show Options
function generateMusic(productId) {
    const product = allProducts.find(p => p.id == productId);
    if (!product) {
        showMessage('‚ùå Product not found', 'error');
        return;
    }
    
    currentMusicProduct = product;
    openMusicModal();
}

// Open Music Modal with Options
function openMusicModal() {
    const modal = document.getElementById('musicModal');
    
    // Reset all sections
    document.getElementById('choiceSection').style.display = 'block';
    document.getElementById('promptEditorSection').style.display = 'none';
    document.getElementById('musicProgress').style.display = 'none';
    document.getElementById('musicLoading').style.display = 'none';
    document.getElementById('resultsContent').style.display = 'none';
    document.getElementById('musicError').style.display = 'none';
    document.getElementById('lyricsResult').style.display = 'none';
    document.getElementById('styleResult').style.display = 'none';
    document.getElementById('musicPreviewContainer').style.display = 'none';
    document.getElementById('saveMusicBtn').style.display = 'none';
    
    // Reset results
    generatedLyrics = '';
    generatedStyle = '';
    uploadedMusicUrl = null;
    uploadedMusicFile = null;
    currentMode = null;
    
    // Set product info
    const productName = document.getElementById('musicProductName');
    const productInfo = document.getElementById('musicProductInfo');
    
    if (currentMusicProduct) {
        productName.textContent = currentMusicProduct.name;
        productInfo.textContent = `ID: ${currentMusicProduct.id} | Generate lyrics and music for this product`;
    }
    
    // Reset upload section
    resetMusicUploadSection();
    
    modal.style.display = 'block';
    
    // Add hover effects to buttons
    const buttons = document.querySelectorAll('#choiceSection button');
    buttons.forEach(btn => {
        btn.addEventListener('mouseenter', () => {
            btn.style.transform = 'translateY(-4px)';
            btn.style.boxShadow = '0 10px 30px rgba(0,0,0,0.2)';
        });
        btn.addEventListener('mouseleave', () => {
            btn.style.transform = 'translateY(0)';
            btn.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
        });
    });
}

function closeMusicModal() {
    document.getElementById('musicModal').style.display = 'none';
    currentMusicProduct = null;
    generatedLyrics = '';
    generatedStyle = '';
    uploadedMusicUrl = null;
    uploadedMusicFile = null;
    currentMode = null;
}

// Edit Prompts Before Generation
function editPromptsBeforeGenerate() {
    document.getElementById('choiceSection').style.display = 'none';
    
    // Create prompt editor interface
    const promptEditorSection = document.getElementById('promptEditorSection');
    promptEditorSection.innerHTML = `
        <div style="margin-bottom: 20px;">
            <h3>Edit Prompts Before Generating</h3>
            <p style="color: #7f8c8d; margin-bottom: 20px;">Edit both lyrics and style prompts before generation</p>
        </div>
        
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button id="lyricsTab" class="prompt-tab active" style="
                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                flex: 1;
            ">Lyrics Prompt</button>
            <button id="styleTab" class="prompt-tab" style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                flex: 1;
            ">Style Prompt</button>
        </div>
        
        <div id="lyricsPromptEditor" style="display: block;">
            <h4>üé∂ Lyrics Generation Prompt</h4>
            <div class="prompt-editor">
                <textarea id="lyricsPromptTextarea" placeholder="Edit lyrics prompt..." style="width: 100%; min-height: 200px; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.5; resize: vertical;"></textarea>
            </div>
        </div>
        
        <div id="stylePromptEditor" style="display: none;">
            <h4>üé® Style Generation Prompt</h4>
            <div class="prompt-editor">
                <textarea id="stylePromptTextarea" placeholder="Edit style prompt..." style="width: 100%; min-height: 200px; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.5; resize: vertical;"></textarea>
            </div>
        </div>
        
        <div class="prompt-actions" style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" class="prompt-btn cancel" onclick="cancelPromptEditing()">
                ‚úï Cancel
            </button>
            <button type="button" class="prompt-btn save" onclick="saveBothPromptsAndGenerate()">
                üíæ Save Both & Generate
            </button>
        </div>
    `;
    
    promptEditorSection.style.display = 'block';
    
    // Load current prompts with product data
    document.getElementById('lyricsPromptTextarea').value = customPrompts.lyrics
        .replace(/{productName}/g, currentMusicProduct.name || '')
        .replace(/{description}/g, currentMusicProduct.description || '')
        .replace(/{category}/g, currentMusicProduct.category_name || '')
        .replace(/{cat1}/g, currentMusicProduct.cat1_name || '')
        .replace(/{price}/g, currentMusicProduct.retail_simple_price ? `‚Çπ${currentMusicProduct.retail_simple_price}` : '‚Çπ0.00')
        .replace(/{specialPrice}/g, currentMusicProduct.retail_simple_special_price ? `‚Çπ${currentMusicProduct.retail_simple_special_price}` : '');
    
    document.getElementById('stylePromptTextarea').value = customPrompts.style
        .replace(/{productName}/g, currentMusicProduct.name || '')
        .replace(/{description}/g, currentMusicProduct.description || '')
        .replace(/{category}/g, currentMusicProduct.category_name || '')
        .replace(/{cat1}/g, currentMusicProduct.cat1_name || '')
        .replace(/{price}/g, currentMusicProduct.retail_simple_price ? `‚Çπ${currentMusicProduct.retail_simple_price}` : '‚Çπ0.00')
        .replace(/{specialPrice}/g, currentMusicProduct.retail_simple_special_price ? `‚Çπ${currentMusicProduct.retail_simple_special_price}` : '');
    
    // Tab switching
    document.getElementById('lyricsTab').addEventListener('click', () => {
        document.getElementById('lyricsTab').classList.add('active');
        document.getElementById('styleTab').classList.remove('active');
        document.getElementById('lyricsPromptEditor').style.display = 'block';
        document.getElementById('stylePromptEditor').style.display = 'none';
    });
    
    document.getElementById('styleTab').addEventListener('click', () => {
        document.getElementById('styleTab').classList.add('active');
        document.getElementById('lyricsTab').classList.remove('active');
        document.getElementById('stylePromptEditor').style.display = 'block';
        document.getElementById('lyricsPromptEditor').style.display = 'none';
    });
}

function cancelPromptEditing() {
    document.getElementById('promptEditorSection').style.display = 'none';
    document.getElementById('choiceSection').style.display = 'block';
}

function saveBothPromptsAndGenerate() {
    const lyricsPrompt = document.getElementById('lyricsPromptTextarea').value.trim();
    const stylePrompt = document.getElementById('stylePromptTextarea').value.trim();
    
    if (!lyricsPrompt || !stylePrompt) {
        showMessage('‚ùå Both prompts are required', 'error');
        return;
    }
    
    // Save prompts (remove the current product-specific replacements)
    customPrompts.lyrics = lyricsPrompt
        .replace(currentMusicProduct.name || '', '{productName}')
        .replace(currentMusicProduct.description || '', '{description}')
        .replace(currentMusicProduct.category_name || '', '{category}')
        .replace(currentMusicProduct.cat1_name || '', '{cat1}')
        .replace(currentMusicProduct.retail_simple_price ? `‚Çπ${currentMusicProduct.retail_simple_price}` : '‚Çπ0.00', '{price}')
        .replace(currentMusicProduct.retail_simple_special_price ? `‚Çπ${currentMusicProduct.retail_simple_special_price}` : '', '{specialPrice}');
    
    customPrompts.style = stylePrompt
        .replace(currentMusicProduct.name || '', '{productName}')
        .replace(currentMusicProduct.description || '', '{description}')
        .replace(currentMusicProduct.category_name || '', '{category}')
        .replace(currentMusicProduct.cat1_name || '', '{cat1}')
        .replace(currentMusicProduct.retail_simple_price ? `‚Çπ${currentMusicProduct.retail_simple_price}` : '‚Çπ0.00', '{price}')
        .replace(currentMusicProduct.retail_simple_special_price ? `‚Çπ${currentMusicProduct.retail_simple_special_price}` : '', '{specialPrice}');
    
    savePromptsToStorage();
    
    // Start generation of both
    generateBothLyricsAndStyle();
}

// Generate Immediately
function generateImmediately() {
    document.getElementById('choiceSection').style.display = 'none';
    generateBothLyricsAndStyle();
}

// Generate Both Lyrics and Style in Parallel
async function generateBothLyricsAndStyle() {
    if (!currentMusicProduct) return;
    
    // Show loading and progress
    document.getElementById('musicLoading').style.display = 'block';
    document.getElementById('musicProgress').style.display = 'block';
    document.getElementById('promptEditorSection').style.display = 'none';
    document.getElementById('choiceSection').style.display = 'none';
    document.getElementById('musicError').style.display = 'none';
    document.getElementById('resultsContent').style.display = 'none';
    
    updateMusicProgress(0);
    setMusicTask('Starting generation...', 'Preparing to generate lyrics and style');
    
    try {
        // Prepare prompts with product data
        const lyricsPrompt = customPrompts.lyrics
            .replace(/{productName}/g, currentMusicProduct.name || '')
            .replace(/{description}/g, currentMusicProduct.description || '')
            .replace(/{category}/g, currentMusicProduct.category_name || '')
            .replace(/{cat1}/g, currentMusicProduct.cat1_name || '')
            .replace(/{price}/g, currentMusicProduct.retail_simple_price ? `‚Çπ${currentMusicProduct.retail_simple_price}` : '‚Çπ0.00')
            .replace(/{specialPrice}/g, currentMusicProduct.retail_simple_special_price ? `‚Çπ${currentMusicProduct.retail_simple_special_price}` : '');
        
        const stylePrompt = customPrompts.style
            .replace(/{productName}/g, currentMusicProduct.name || '')
            .replace(/{description}/g, currentMusicProduct.description || '')
            .replace(/{category}/g, currentMusicProduct.category_name || '')
            .replace(/{cat1}/g, currentMusicProduct.cat1_name || '')
            .replace(/{price}/g, currentMusicProduct.retail_simple_price ? `‚Çπ${currentMusicProduct.retail_simple_price}` : '‚Çπ0.00')
            .replace(/{specialPrice}/g, currentMusicProduct.retail_simple_special_price ? `‚Çπ${currentMusicProduct.retail_simple_special_price}` : '');
        
        // Start both requests in parallel
        setMusicTask('Generating lyrics...', 'Creating lyrics based on product description');
        updateMusicProgress(25);
        
        const lyricsPromise = fetch('/api/ai/generate-lyrics', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                productName: currentMusicProduct.name,
                description: currentMusicProduct.description || '',
                category: currentMusicProduct.category_name || '',
                cat1: currentMusicProduct.cat1_name || '',
                price: currentMusicProduct.retail_simple_price || 0,
                specialPrice: currentMusicProduct.retail_simple_special_price || 0,
                prompt: lyricsPrompt
            })
        }).then(async response => {
            const result = await response.json();
            if (result.success && result.lyrics) {
                generatedLyrics = result.lyrics;
                updateMusicProgress(75);
                return result;
            } else {
                throw new Error(result.error || 'Failed to generate lyrics');
            }
        });
        
        setMusicTask('Generating style...', 'Creating music style based on product information');
        updateMusicProgress(50);
        
        const stylePromise = fetch('/api/ai/generate-style', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                productName: currentMusicProduct.name,
                description: currentMusicProduct.description || '',
                category: currentMusicProduct.category_name || '',
                cat1: currentMusicProduct.cat1_name || '',
                price: currentMusicProduct.retail_simple_price || 0,
                specialPrice: currentMusicProduct.retail_simple_special_price || 0,
                prompt: stylePrompt
            })
        }).then(async response => {
            const result = await response.json();
            if (result.success && result.style) {
                generatedStyle = result.style;
                updateMusicProgress(90);
                return result;
            } else {
                throw new Error(result.error || 'Failed to generate style');
            }
        });
        
        // Wait for both to complete
        await Promise.all([lyricsPromise, stylePromise]);
        
        updateMusicProgress(100);
        
        // Show results
        showGenerationResults();
        
    } catch (error) {
        console.error('Generation error:', error);
        showMusicError(error.message);
    }
}

function showGenerationResults() {
    document.getElementById('musicLoading').style.display = 'none';
    document.getElementById('resultsContent').style.display = 'block';
    
    // Show both results
    document.getElementById('lyricsResult').style.display = 'block';
    document.getElementById('styleResult').style.display = 'block';
    document.getElementById('generatedLyrics').textContent = generatedLyrics;
    document.getElementById('generatedStyle').textContent = generatedStyle;
    
    // Setup drag and drop for music files
    setupMusicDragAndDrop();
}

function updateMusicProgress(percentage) {
    document.getElementById('musicProgressBar').style.width = percentage + '%';
    
    // Update step indicators
    const steps = ['step1', 'step2'];
    steps.forEach((stepId, index) => {
        const step = document.getElementById(stepId);
        step.className = 'ai-step';
        if (percentage >= (index + 1) * 50) {
            step.classList.add('completed');
        } else if (percentage >= index * 50) {
            step.classList.add('active');
        }
    });
}

function setMusicTask(task, details) {
    document.getElementById('musicCurrentTask').textContent = task;
    document.getElementById('musicTaskDetails').textContent = details;
}

function showMusicError(message) {
    document.getElementById('musicLoading').style.display = 'none';
    document.getElementById('musicError').style.display = 'block';
    document.getElementById('musicErrorMessage').textContent = message;
}

function retryGeneration() {
    document.getElementById('musicError').style.display = 'none';
    generateBothLyricsAndStyle();
}

// Copy to clipboard
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
        showMessage('‚úÖ Copied to clipboard!', 'success');
    }).catch(err => {
        showMessage('‚ùå Failed to copy', 'error');
    });
}

// Setup drag and drop for music files
function setupMusicDragAndDrop() {
    const uploadContainer = document.getElementById('musicUploadContainer');
    const fileInput = document.getElementById('musicFileInput');
    
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadContainer.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    // Highlight drop zone
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadContainer.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        uploadContainer.addEventListener(eventName, unhighlight, false);
    });
    
    // Handle dropped files
    uploadContainer.addEventListener('drop', handleMusicDrop, false);
    
    // Handle file input change
    fileInput.addEventListener('change', handleMusicFileSelect, false);
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    function highlight() {
        uploadContainer.classList.add('dragover');
    }
    
    function unhighlight() {
        uploadContainer.classList.remove('dragover');
    }
    
    function handleMusicDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleMusicFiles(files);
    }
    
    function handleMusicFileSelect(e) {
        const files = e.target.files;
        handleMusicFiles(files);
    }
}

function handleMusicFiles(files) {
    if (files.length === 0) return;
    
    const file = files[0];
    
    // Validate file type
    const validTypes = ['audio/mpeg', 'audio/wav', 'audio/x-wav', 'audio/mp4', 'audio/x-m4a'];
    const validExtensions = ['.mp3', '.wav', '.m4a'];
    const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
    
    if (!validTypes.includes(file.type) && !validExtensions.includes(fileExtension)) {
        showMessage('‚ùå Please select a valid audio file (MP3, WAV, M4A)', 'error');
        return;
    }
    
    // Validate file size (10MB max)
    if (file.size > 10 * 1024 * 1024) {
        showMessage('‚ùå Audio file size must be less than 10MB', 'error');
        return;
    }
    
    uploadedMusicFile = file;
    
    // Show preview
    const reader = new FileReader();
    reader.onload = function(e) {
        const preview = document.getElementById('uploadedMusicPreview');
        preview.src = e.target.result;
        document.getElementById('musicPreviewContainer').style.display = 'block';
        document.getElementById('saveMusicBtn').style.display = 'block';
        
        // Show upload status
        const statusDiv = document.getElementById('uploadStatus');
        statusDiv.className = 'upload-status success';
        statusDiv.textContent = '‚úÖ Music file ready to save';
    };
    reader.readAsDataURL(file);
    
    // Upload the file
    uploadMusicFile(file);
}

async function uploadMusicFile(file) {
    try {
        const statusDiv = document.getElementById('uploadStatus');
        statusDiv.className = 'upload-status processing';
        statusDiv.textContent = 'üîÑ Uploading music file...';
        
        const formData = new FormData();
        formData.append('image', file);
        
        const response = await fetch('https://api.zulushop.in/api/v1/user/upload', {
            method: 'POST',
            body: formData
        });
        
        const responseText = await response.text();
        
        if (response.ok) {
            let jsonRes;
            try {
                jsonRes = JSON.parse(responseText);
            } catch {
                throw new Error('Invalid response from server');
            }
            
            let url = jsonRes.url || jsonRes.image_url || 
                     (jsonRes.data ? (typeof jsonRes.data === 'string' ? jsonRes.data : 
                     jsonRes.data.url || jsonRes.data.image_url) : null);
            
            if (url) {
                uploadedMusicUrl = url;
                
                statusDiv.className = 'upload-status success';
                statusDiv.textContent = '‚úÖ Music uploaded successfully!';
                
                showMessage('‚úÖ Music uploaded successfully!', 'success');
                return url;
            } else {
                throw new Error('No URL in response');
            }
        } else {
            throw new Error(`Upload failed: ${response.status}`);
        }
    } catch (error) {
        console.error('Music upload failed:', error);
        
        const statusDiv = document.getElementById('uploadStatus');
        statusDiv.className = 'upload-status error';
        statusDiv.textContent = `‚ùå Upload failed: ${error.message}`;
        
        showMessage(`‚ùå Music upload failed: ${error.message}`, 'error');
        throw error;
    }
}

function resetMusicUploadSection() {
    uploadedMusicUrl = null;
    uploadedMusicFile = null;
    document.getElementById('musicPreviewContainer').style.display = 'none';
    document.getElementById('saveMusicBtn').style.display = 'none';
    document.getElementById('musicFileInput').value = '';
    const statusDiv = document.getElementById('uploadStatus');
    statusDiv.className = 'upload-status';
    statusDiv.textContent = '';
}

// Save music URL to product's download_link field
async function saveMusicToProduct() {
    if (!currentMusicProduct || !uploadedMusicUrl) {
        showMessage('‚ùå Please upload a music file first', 'error');
        return;
    }
    
    try {
        showMessage('üîÑ Saving music to product...', 'info');
        
        // Save to download_link field instead of description
        const updateData = {
            download_link: uploadedMusicUrl  // Changed from description to download_link
        };
        
        const response = await fetch(`/api/products/${currentMusicProduct.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updateData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update the product in allProducts array
            const productIndex = allProducts.findIndex(p => p.id == currentMusicProduct.id);
            if (productIndex !== -1) {
                allProducts[productIndex].download_link = uploadedMusicUrl;
            }
            
            showMessage('‚úÖ Music link saved to download_link field!', 'success');
            
            // Update status in modal
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.className = 'upload-status success';
            statusDiv.innerHTML = '‚úÖ Music link saved to download_link!';
            
            // Close modal after delay
            setTimeout(() => {
                closeMusicModal();
                // Refresh display
                filterProducts();
            }, 1500);
        } else {
            throw new Error(result.error || 'Failed to save music');
        }
    } catch (error) {
        console.error('Error saving music:', error);
        showMessage(`‚ùå Error: ${error.message}`, 'error');
    }
}

        async function generateLyrics() {
            if (!currentMusicProduct) return;
            
            document.getElementById('musicLoading').style.display = 'block';
            document.getElementById('musicError').style.display = 'none';
            document.getElementById('lyricsContent').style.display = 'none';
            document.getElementById('generateLyricsBtn').style.display = 'none';
            
            setMusicTask('Generating lyrics...', 'Creating a 30-second song based on product description');
            
            try {
                const response = await fetch('/api/ai/generate-lyrics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productName: currentMusicProduct.name,
                        description: currentMusicProduct.description || '',
                        category: currentMusicProduct.category_name || '',
                        cat1: currentMusicProduct.cat1_name || ''
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.lyrics) {
                    generatedLyrics = result.lyrics;
                    
                    document.getElementById('musicLoading').style.display = 'none';
                    document.getElementById('lyricsContent').style.display = 'block';
                    document.getElementById('generateLyricsBtn').style.display = 'block';
                    
                    const lyricsContainer = document.getElementById('generatedLyrics');
                    lyricsContainer.textContent = result.lyrics;
                    
                    if (!document.getElementById('copyLyricsBtn')) {
                        const copyBtn = document.createElement('button');
                        copyBtn.id = 'copyLyricsBtn';
                        copyBtn.className = 'image-action-btn';
                        copyBtn.style.marginTop = '10px';
                        copyBtn.innerHTML = 'üìã Copy Lyrics';
                        copyBtn.onclick = copyLyricsToClipboard;
                        lyricsContainer.parentNode.insertBefore(copyBtn, lyricsContainer.nextSibling);
                    }
                    
                    showMessage('‚úÖ Lyrics generated successfully!', 'success');
                } else {
                    throw new Error(result.error || 'Failed to generate lyrics');
                }
            } catch (error) {
                console.error('Lyrics generation error:', error);
                showMusicError(error.message);
            }
        }
        


        function retryMusicGeneration() {
            document.getElementById('musicError').style.display = 'none';
            generateLyrics();
        }
        
        function copyLyricsToClipboard() {
            if (!generatedLyrics) return;
            
            navigator.clipboard.writeText(generatedLyrics).then(() => {
                const copyBtn = document.getElementById('copyLyricsBtn');
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '‚úÖ Copied!';
                copyBtn.style.background = '#4CAF50';
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.style.background = '';
                }, 2000);
            });
        }

        
        // AI Functions
        function runAITasks(productId) {
            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                showMessage('‚ùå Product not found', 'error');
                return;
            }
            
            currentAIProduct = product;
            aiResults = {
                enhancedImage: null,
                suggestedCategory: null,
                suggestedCat1: null,
                tags: [],
                description: '',
                extraDescription: ''
            };
            
            openAIResultsModal();
            startAITasks();
        }
        
        function openAIResultsModal() {
            const modal = document.getElementById('aiResultsModal');
            const productName = document.getElementById('aiProductName');
            const productInfo = document.getElementById('aiProductInfo');
            
            if (currentAIProduct) {
                productName.textContent = currentAIProduct.name;
                productInfo.textContent = `ID: ${currentAIProduct.id} | ${currentAIProduct.category_name || 'No Category'}`;
            }
            
            document.getElementById('aiLoading').style.display = 'block';
            document.getElementById('aiError').style.display = 'none';
            document.getElementById('aiResultsContent').style.display = 'none';
            document.getElementById('aiProgress').style.display = 'flex';
            document.getElementById('aiApplyChangesBtn').style.display = 'none';
            
            document.getElementById('aiImageResult').style.display = 'none';
            document.getElementById('aiCategoryResult').style.display = 'none';
            document.getElementById('aiTagsResult').style.display = 'none';
            document.getElementById('aiDescriptionResult').style.display = 'none';
            
            modal.style.display = 'block';
        }
        
        function closeAIResultsModal() {
            document.getElementById('aiResultsModal').style.display = 'none';
            currentAIProduct = null;
            aiResults = null;
        }
        
        async function startAITasks() {
            try {
                updateProgress(0);
                setCurrentTask('Enhancing image...', 'Step 1: Processing image enhancement');
                await enhanceImage();
                
                updateProgress(25);
                setCurrentTask('Analyzing categories...', 'Step 2: Analyzing product categorization');
                await analyzeCategories();
                
                updateProgress(50);
                setCurrentTask('Generating tags...', 'Step 3: Creating relevant tags');
                await generateTags();
                
                updateProgress(75);
                setCurrentTask('Creating descriptions...', 'Step 4: Writing product descriptions');
                await generateDescriptions();
                
                updateProgress(100);
                setCurrentTask('All tasks completed!', 'AI processing finished successfully');
                
                setTimeout(() => {
                    showAIResults();
                }, 1000);
                
            } catch (error) {
                console.error('AI tasks failed:', error);
                showAIError(error.message);
            }
        }
        
        function updateProgress(percentage) {
            document.getElementById('aiProgressBar').style.width = percentage + '%';
            
            const steps = ['step1', 'step2', 'step3', 'step4'];
            steps.forEach((stepId, index) => {
                const step = document.getElementById(stepId);
                step.className = 'ai-step';
                if (percentage >= (index + 1) * 25) {
                    step.classList.add('completed');
                } else if (percentage >= index * 25) {
                    step.classList.add('active');
                }
            });
        }
        
        function setCurrentTask(task, details) {
            document.getElementById('aiCurrentTask').textContent = task;
            document.getElementById('aiTaskDetails').textContent = details;
        }
        
        async function enhanceImage() {
            if (!currentAIProduct || !currentAIProduct.image) {
                aiResults.enhancedImage = currentAIProduct.image;
                return;
            }
            
            try {
                const response = await fetch('/api/ai/enhance-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        imageUrl: currentAIProduct.image,
                        productName: currentAIProduct.name
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.enhancedImageUrl) {
                    aiResults.enhancedImage = result.enhancedImageUrl;
                } else {
                    aiResults.enhancedImage = currentAIProduct.image;
                    aiResults.imageWarning = result.message || result.error;
                }
            } catch (error) {
                aiResults.enhancedImage = currentAIProduct.image;
                aiResults.imageWarning = 'Image enhancement failed. Using original image.';
            }
        }
        
        async function analyzeCategories() {
            try {
                const response = await fetch('/api/ai/analyze-categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productName: currentAIProduct.name,
                        currentCategory: currentAIProduct.category_name,
                        currentCat1: currentAIProduct.cat1_name,
                        imageUrl: currentAIProduct.image,
                        description: currentAIProduct.description || ''
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    aiResults.suggestedCategory = result.suggestedCategory;
                    aiResults.suggestedCat1 = result.suggestedCat1;
                    aiResults.categoryAnalysis = result.analysis;
                    if (result.warning) {
                        aiResults.categoryWarning = result.warning;
                    }
                } else {
                    throw new Error(result.error || 'Category analysis failed');
                }
            } catch (error) {
                aiResults.suggestedCategory = {
                    id: currentAIProduct.category_id,
                    name: currentAIProduct.category_name || 'Unknown'
                };
                aiResults.suggestedCat1 = {
                    id: currentAIProduct.cat1,
                    name: currentAIProduct.cat1_name || 'Unknown'
                };
                aiResults.categoryAnalysis = "Analysis failed. Using existing categories.";
                aiResults.categoryWarning = error.message;
            }
        }
        
        async function generateTags() {
            try {
                const response = await fetch('/api/ai/generate-tags', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productName: currentAIProduct.name,
                        category: aiResults.suggestedCategory?.name || currentAIProduct.category_name,
                        cat1: aiResults.suggestedCat1?.name || currentAIProduct.cat1_name,
                        description: currentAIProduct.description || '',
                        price: currentAIProduct.retail_simple_price || 0
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.tags) {
                    aiResults.tags = result.tags;
                } else {
                    aiResults.tags = generateBasicTags();
                }
            } catch (error) {
                aiResults.tags = generateBasicTags();
            }
        }
        
        function generateBasicTags() {
            const tags = [];
            if (currentAIProduct.name) {
                const words = currentAIProduct.name.toLowerCase().split(' ');
                tags.push(...words.slice(0, 5));
            }
            if (currentAIProduct.category_name) {
                tags.push(currentAIProduct.category_name.toLowerCase());
            }
            return [...new Set(tags)].slice(0, 10);
        }
        
        async function generateDescriptions() {
            try {
                const response = await fetch('/api/ai/generate-descriptions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productName: currentAIProduct.name,
                        category: aiResults.suggestedCategory?.name || currentAIProduct.category_name,
                        cat1: aiResults.suggestedCat1?.name || currentAIProduct.cat1_name,
                        tags: aiResults.tags,
                        price: currentAIProduct.retail_simple_price || 0,
                        currentDescription: currentAIProduct.description || ''
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    aiResults.description = result.description || '';
                    aiResults.extraDescription = result.extraDescription || '';
                } else {
                    throw new Error(result.error || 'Description generation failed');
                }
            } catch (error) {
                aiResults.description = currentAIProduct.description || 'No description available';
                aiResults.extraDescription = 'Special product at great value!';
            }
        }
        
        function showAIResults() {
            document.getElementById('aiLoading').style.display = 'none';
            document.getElementById('aiError').style.display = 'none';
            document.getElementById('aiResultsContent').style.display = 'block';
            document.getElementById('aiApplyChangesBtn').style.display = 'block';
            
            const imageResultDiv = document.getElementById('aiImageResult');
            imageResultDiv.style.display = 'block';
            
            const img = document.getElementById('aiEnhancedImage');
            const imageActions = document.getElementById('aiImageActions');
            
            img.src = 'https://via.placeholder.com/300x200?text=Loading+Enhanced+Image';
            
            if (aiResults.enhancedImage && aiResults.enhancedImage !== 'null') {
                const testImage = new Image();
                testImage.onload = () => {
                    img.src = aiResults.enhancedImage;
                    imageActions.innerHTML = `
                        <button onclick="window.open('${aiResults.enhancedImage}', '_blank')" class="image-action-btn">
                            üëÅÔ∏è View Full Image
                        </button>
                    `;
                    
                    if (aiResults.imageWarning) {
                        const warningDiv = document.createElement('div');
                        warningDiv.style.marginTop = '10px';
                        warningDiv.style.padding = '8px';
                        warningDiv.style.background = '#fff3cd';
                        warningDiv.style.color = '#856404';
                        warningDiv.style.borderRadius = '4px';
                        warningDiv.style.fontSize = '12px';
                        warningDiv.innerHTML = `<strong>Note:</strong> ${aiResults.imageWarning}`;
                        imageActions.appendChild(warningDiv);
                    }
                };
                
                testImage.onerror = () => {
                    img.src = 'https://via.placeholder.com/300x200?text=Enhanced+Image+Failed';
                    imageActions.innerHTML = `
                        <button onclick="retryAITasks()" class="image-action-btn">
                            üîÑ Retry Image Enhancement
                        </button>
                        <div style="margin-top: 10px; color: #e74c3c; font-size: 12px;">
                            Failed to load enhanced image.
                        </div>
                    `;
                };
                
                testImage.src = aiResults.enhancedImage;
            } else {
                img.src = 'https://via.placeholder.com/300x200?text=No+Enhanced+Image';
                imageActions.innerHTML = `
                    <button onclick="retryAITasks()" class="image-action-btn">
                        üîÑ Retry Image Enhancement
                    </button>
                `;
            }
            
            document.getElementById('aiCategoryResult').style.display = 'block';
            document.getElementById('aiSuggestedCategory').textContent = 
                `${aiResults.suggestedCategory?.name || 'No suggestion'} (ID: ${aiResults.suggestedCategory?.id || 'N/A'})`;
            document.getElementById('aiSuggestedCat1').textContent = 
                aiResults.suggestedCat1 ? 
                    `${aiResults.suggestedCat1.name} (ID: ${aiResults.suggestedCat1.id})` : 
                    'No suggestion';
            document.getElementById('aiCategoryAnalysis').textContent = 
                aiResults.categoryAnalysis || 'Analysis not available';
            
            if (aiResults.categoryWarning) {
                const warningDiv = document.createElement('div');
                warningDiv.style.marginTop = '10px';
                warningDiv.style.padding = '8px';
                warningDiv.style.background = '#fff3cd';
                warningDiv.style.color = '#856404';
                warningDiv.style.borderRadius = '4px';
                warningDiv.style.fontSize = '12px';
                warningDiv.innerHTML = `<strong>Note:</strong> ${aiResults.categoryWarning}`;
                document.getElementById('aiCategoryResult').appendChild(warningDiv);
            }
            
            document.getElementById('aiTagsResult').style.display = 'block';
            const tagsList = document.getElementById('aiTagsList');
            tagsList.innerHTML = '';
            
            if (aiResults.tags && aiResults.tags.length > 0) {
                aiResults.tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'ai-tag';
                    tagElement.textContent = tag;
                    tagElement.style.margin = '2px';
                    tagsList.appendChild(tagElement);
                });
            } else {
                tagsList.innerHTML = '<span style="color: #7f8c8d;">No tags generated</span>';
            }
            
            document.getElementById('aiDescriptionResult').style.display = 'block';
            document.getElementById('aiMainDescription').textContent = 
                aiResults.description || 'No description generated';
            document.getElementById('aiExtraDescription').innerHTML = 
                (aiResults.extraDescription || 'No extra description generated')
                    .split('\n')
                    .map(line => `<div style="margin: 5px 0;">${line}</div>`)
                    .join('');
        }
        
        function showAIError(message) {
            document.getElementById('aiLoading').style.display = 'none';
            document.getElementById('aiError').style.display = 'block';
            document.getElementById('aiErrorMessage').textContent = message;
        }
        
        function retryAITasks() {
            if (currentAIProduct) {
                startAITasks();
                document.getElementById('aiError').style.display = 'none';
                document.getElementById('aiLoading').style.display = 'block';
            }
        }
        
        async function applyAIResults() {
            if (!currentAIProduct || !aiResults) {
                showMessage('‚ùå No AI results to apply', 'error');
                return;
            }
            
            const updateData = {};
            
            if (aiResults.enhancedImage && aiResults.enhancedImage !== currentAIProduct.image) {
                try {
                    showMessage('üîÑ Uploading enhanced image to server...', 'info');
                    const imageResponse = await fetch(aiResults.enhancedImage);
                    const imageBlob = await imageResponse.blob();
                    const fileName = `enhanced_${currentAIProduct.id}_${Date.now()}.jpg`;
                    const enhancedImageFile = new File([imageBlob], fileName, { type: 'image/jpeg' });
                    
                    const formData = new FormData();
                    formData.append('image', enhancedImageFile);
                    
                    const uploadResponse = await fetch('https://api.zulushop.in/api/v1/user/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const uploadResult = await uploadResponse.text();
                    const jsonResult = JSON.parse(uploadResult);
                    const uploadedImageUrl = jsonResult.url || jsonResult.image_url || 
                                           (jsonResult.data ? (typeof jsonResult.data === 'string' ? jsonResult.data : 
                                           jsonResult.data.url || jsonResult.data.image_url) : null);
                    
                    if (uploadedImageUrl) {
                        updateData.image = uploadedImageUrl;
                        showMessage('‚úÖ Enhanced image uploaded successfully!', 'success');
                    }
                } catch (error) {
                    showMessage('‚ö†Ô∏è Failed to upload enhanced image, keeping original', 'warning');
                }
            }
            
            if (aiResults.suggestedCategory) {
                updateData.category_id = aiResults.suggestedCategory.id;
            }
            
            if (aiResults.suggestedCat1) {
                updateData.cat1 = aiResults.suggestedCat1.id;
            }
            
            if (aiResults.tags && aiResults.tags.length > 0) {
                updateData.tags = aiResults.tags.join(',');
            }
            
            if (aiResults.description && aiResults.description.trim() !== '') {
                updateData.description = aiResults.description;
            }
            
            if (aiResults.extraDescription && aiResults.extraDescription.trim() !== '') {
                updateData.extra_description = aiResults.extraDescription;
            }
            
            if (Object.keys(updateData).length === 0) {
                showMessage('‚ÑπÔ∏è No changes to apply', 'info');
                closeAIResultsModal();
                return;
            }
            
            showMessage('üîÑ Applying AI updates to database...', 'info');
            
            try {
                const response = await fetch(`/api/products/${currentAIProduct.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const productIndex = allProducts.findIndex(p => p.id == currentAIProduct.id);
                    if (productIndex !== -1) {
                        if (updateData.image) {
                            allProducts[productIndex].image = updateData.image;
                            allProducts[productIndex].hasImage = true;
                        }
                        
                        Object.keys(updateData).forEach(key => {
                            allProducts[productIndex][key] = updateData[key];
                        });
                        
                        if (updateData.category_id) {
                            const category = categoriesList.find(cat => cat.id == updateData.category_id);
                            if (category) {
                                allProducts[productIndex].category_name = category.name;
                            }
                        }
                        
                        if (updateData.cat1) {
                            const cat1Item = categoriesList.find(cat => cat.id == updateData.cat1);
                            if (cat1Item) {
                                allProducts[productIndex].cat1_name = cat1Item.name;
                            }
                        }
                    }
                    
                    filterProducts();
                    showMessage('‚úÖ AI updates applied successfully!', 'success');
                    closeAIResultsModal();
                } else {
                    showMessage(`‚ùå Error applying updates: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`‚ùå Network error: ${error.message}`, 'error');
            }
        }
        
        // Event delegation for better performance
        document.addEventListener('click', function(e) {
            // Handle modals closing
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
        
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        });
</script>
</body>
</html>